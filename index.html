<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>Smart Gallery · Premium PWA</title>
  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#3b82f6">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="icon.png">
  <!-- Tailwind + Fonts -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'sans-serif'] },
          animation: {
            'bounce-slow': 'bounce 3s infinite',
            'fade-in': 'fadeIn 0.3s ease-out'
          },
          keyframes: {
            fadeIn: { '0%': { opacity: 0 }, '100%': { opacity: 1 } },
            fadeSlideUp: { '0%': { opacity: 0, transform: 'translateY(10px)' } }
          }
        }
      }
    }
  </script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    /* ----- Global ----- */
    body { font-family: 'Inter', sans-serif; -webkit-font-smoothing: antialiased; }
    .glass-nav { background: rgba(255,255,255,0.7); backdrop-filter: blur(16px); border-bottom: 1px solid rgba(0,0,0,0.05); }
    .dark .glass-nav { background: rgba(15,23,42,0.7); border-bottom: 1px solid rgba(255,255,255,0.05); }
    .glass-modal { background: rgba(255,255,255,0.6); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.2); }
    .dark .glass-modal { background: rgba(15,23,42,0.7); border: 1px solid rgba(255,255,255,0.05); }
    .img-loading { opacity: 0; transform: scale(1.05); filter: blur(10px); }
    .img-loaded { opacity: 1; transform: scale(1); filter: blur(0); transition: all 0.7s cubic-bezier(0.4,0,0.2,1); }
    .animate-enter { animation: fadeSlideUp 0.5s cubic-bezier(0.16,1,0.3,1) forwards; }
    @keyframes fadeSlideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    .dark ::-webkit-scrollbar-thumb { background: #334155; }

    /* ----- Favorites Zone (horizontal scroll) ----- */
    .favorites-zone {
      display: flex;
      gap: 1rem;
      overflow-x: auto;
      scroll-snap-type: x mandatory;
      padding-bottom: 0.5rem;
      scrollbar-width: thin;
    }
    .favorites-zone .fav-item {
      flex: 0 0 120px;
      scroll-snap-align: start;
    }
    @media (min-width: 640px) { .favorites-zone .fav-item { flex-basis: 150px; } }

    /* ----- Accessibility focus ----- */
    a:focus-visible, button:focus-visible, [tabindex]:focus-visible {
      outline: 3px solid #3b82f6;
      outline-offset: 2px;
      border-radius: 4px;
    }

    /* ----- Lightbox zoom ----- */
    #lightbox-img { transition: transform 0.2s ease, filter 0.2s ease; }

    /* ----- Skip link ----- */
    .skip-link {
      position: absolute;
      top: -40px;
      left: 0;
      background: #3b82f6;
      color: white;
      padding: 8px;
      z-index: 100;
    }
    .skip-link:focus { top: 0; }

    /* ----- Upload modal tabs ----- */
    .upload-tab.active {
      background: white;
      color: #3b82f6;
      box-shadow: 0 4px 10px -4px rgba(59,130,246,0.3);
    }
    .dark .upload-tab.active {
      background: #1e293b;
      color: #93c5fd;
    }
  </style>
</head>
<body id="app-body" class="bg-slate-50 text-slate-900 dark:bg-slate-950 dark:text-slate-100 transition-colors duration-500 flex flex-col min-h-screen">
  <!-- Skip to content -->
  <a href="#main-content" class="skip-link">Skip to main content</a>

  <!-- ========== NAVIGATION ========== -->
  <nav class="fixed top-0 w-full z-50 glass-nav transition-all duration-300" aria-label="Main navigation">
    <div class="container mx-auto px-4 h-16 flex justify-between items-center">
      <div class="flex items-center gap-2 sm:gap-3 group" onclick="window.location.reload()" role="button" tabindex="0" aria-label="Reload app">
        <div class="w-9 h-9 bg-gradient-to-br from-blue-600 to-blue-500 rounded-xl flex items-center justify-center text-white shadow-lg group-hover:scale-105 transition-transform flex-shrink-0">
          <i class="fa-solid fa-bolt" aria-hidden="true"></i>
        </div>
        <h1 class="block text-lg font-bold tracking-tight">Smart<span class="text-blue-600">Gallery</span></h1>
      </div>
      
      <div class="flex items-center gap-2 sm:gap-3 flex-grow justify-end">
        <!-- Search -->
        <div class="relative">
          <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-xs sm:text-sm" aria-hidden="true"></i>
          <input type="text" id="searchInput" placeholder="Search albums..." 
                class="bg-white/50 dark:bg-slate-800/50 border border-transparent focus:border-blue-500/50 rounded-full py-2 pl-9 pr-4 text-xs sm:text-sm w-28 sm:w-64 focus:ring-4 focus:ring-blue-500/10 outline-none transition-all placeholder-slate-400 dark:text-white backdrop-blur-sm"
                aria-label="Search albums by name">
        </div>
        <!-- Upload button -->
        <button id="uploadBtn" class="w-9 h-9 rounded-full bg-white/50 dark:bg-slate-800/50 hover:bg-blue-50 dark:hover:bg-slate-800 border border-transparent hover:border-blue-200 dark:hover:border-slate-700 flex items-center justify-center text-blue-600 dark:text-blue-400 transition-all flex-shrink-0 backdrop-blur-sm" aria-label="Upload images">
          <i class="fa-solid fa-cloud-upload-alt text-sm" aria-hidden="true"></i>
        </button>
        <!-- Theme toggle -->
        <button id="themeToggle" class="w-9 h-9 rounded-full bg-white/50 dark:bg-slate-800/50 hover:bg-yellow-50 dark:hover:bg-slate-800 border border-transparent hover:border-yellow-200 dark:hover:border-slate-700 flex items-center justify-center text-slate-600 dark:text-yellow-400 transition-all flex-shrink-0 backdrop-blur-sm" aria-label="Toggle dark mode">
          <i class="fa-solid fa-moon dark:hidden text-sm" aria-hidden="true"></i>
          <i class="fa-solid fa-sun hidden dark:block text-sm" aria-hidden="true"></i>
        </button>
      </div>
    </div>
  </nav>
  <div class="h-24"></div>

  <!-- ========== MAIN CONTENT ========== -->
  <main id="main-content" class="container mx-auto px-4 sm:px-6 flex-grow relative">
    <!-- PEOPLE / ALBUMS VIEW -->
    <div id="people-view" class="animate-enter pb-12">
      <!-- HIGH FAVORITES ZONE -->
      <div id="favorites-zone" class="mb-12 hidden">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl sm:text-2xl font-extrabold tracking-tight flex items-center gap-2">
            <i class="fa-solid fa-heart text-rose-500" aria-hidden="true"></i>
            <span>Favorites Zone</span>
          </h2>
          <button id="viewAllFavorites" class="text-xs font-bold text-blue-600 hover:text-blue-700 dark:text-blue-400 px-3 py-1.5 rounded-full bg-blue-50 dark:bg-blue-900/30 transition" aria-label="View all favorite photos">View All</button>
        </div>
        <div id="favoritesScroll" class="favorites-zone pb-2" aria-label="Scrollable list of favorite photos"></div>
      </div>

      <!-- Albums header -->
      <div class="mb-8 flex flex-col sm:flex-row sm:items-end justify-between gap-2">
        <div>
          <h2 id="greeting" class="text-3xl sm:text-4xl font-extrabold tracking-tight text-slate-900 dark:text-white">Albums</h2>
          <p class="text-slate-500 dark:text-slate-400 mt-1 text-sm font-medium">Your memories, beautifully organized.</p>
        </div>
        <div id="album-count" class="text-xs font-bold text-blue-600 bg-blue-50 dark:bg-blue-900/30 px-3 py-1.5 rounded-full">Loading...</div>
      </div>
      
      <div id="people-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4 sm:gap-6"></div>
      <div id="no-albums" class="hidden text-center py-20">
        <p class="text-slate-500 dark:text-slate-400">No albums match your search.</p>
      </div>
    </div>

    <!-- GALLERY VIEW -->
    <div id="gallery-view" class="hidden animate-enter pb-12">
      <div class="sticky top-20 z-30 -mx-4 px-4 sm:mx-0 sm:px-0 mb-8">
        <div class="bg-white/80 dark:bg-slate-900/80 backdrop-blur-xl border border-slate-200/50 dark:border-slate-800/50 shadow-lg rounded-2xl p-3 sm:p-4 flex items-center justify-between transition-all">
          <div class="flex items-center gap-4">
            <button id="backButton" class="w-10 h-10 flex items-center justify-center rounded-full bg-slate-100 dark:bg-slate-800 hover:bg-slate-900 hover:text-white dark:hover:bg-white dark:hover:text-slate-900 transition-all shadow-sm" aria-label="Go back to albums">
              <i class="fa-solid fa-arrow-left text-sm" aria-hidden="true"></i>
            </button>
            <div class="flex items-center gap-3">
              <div id="header-avatar-container" class="w-10 h-10 rounded-full overflow-hidden shadow-md ring-2 ring-white dark:ring-slate-700 flex items-center justify-center bg-slate-100 dark:bg-slate-800">
                <img id="header-avatar" src="" alt="" class="w-full h-full object-cover opacity-0 transition-opacity duration-500" onload="this.classList.remove('opacity-0')">
                <i id="header-icon" class="hidden fa-solid fa-layer-group text-blue-500 text-lg" aria-hidden="true"></i>
              </div>
              <div class="leading-tight">
                <h2 id="header-name" class="text-lg font-bold text-slate-900 dark:text-white">Name</h2>
                <p id="header-count" class="text-xs text-slate-500 dark:text-slate-400 font-medium">0 Photos</p>
              </div>
            </div>
          </div>
          
          <!-- View Settings -->
          <div class="relative">
            <button id="settings-btn" class="w-10 h-10 rounded-full bg-slate-100 dark:bg-slate-800 hover:bg-blue-50 dark:hover:bg-slate-700 text-slate-600 dark:text-slate-300 transition flex items-center justify-center shadow-sm" aria-label="View settings" aria-haspopup="true" aria-expanded="false">
              <i class="fa-solid fa-sliders" aria-hidden="true"></i>
            </button>
            <div id="view-settings-dropdown" class="hidden absolute right-0 top-12 w-56 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl shadow-xl z-40 p-3 animate-enter" role="menu">
              <div class="space-y-4">
                <div role="group" aria-label="Grid layout">
                  <p class="text-[10px] uppercase font-bold text-slate-400 mb-2">Grid Layout</p>
                  <div class="flex bg-slate-100 dark:bg-slate-800 p-1 rounded-lg">
                    <button id="btn-masonry" class="flex-1 py-1.5 rounded-md text-xs font-medium transition-colors" data-type="masonry">Masonry</button>
                    <button id="btn-square" class="flex-1 py-1.5 rounded-md text-xs font-medium transition-colors" data-type="square">Square</button>
                  </div>
                </div>
                <div role="group" aria-label="Thumbnail size">
                  <p class="text-[10px] uppercase font-bold text-slate-400 mb-2">Thumbnail Size</p>
                  <div class="flex justify-between items-center bg-slate-100 dark:bg-slate-800 p-1 rounded-lg px-2">
                    <button id="btn-size-s" data-size="small" class="w-8 h-8 rounded hover:bg-white dark:hover:bg-slate-700 transition flex items-center justify-center text-slate-500" aria-label="Small thumbnails"><i class="fa-solid fa-border-all text-xs"></i></button>
                    <button id="btn-size-m" data-size="medium" class="w-8 h-8 rounded hover:bg-white dark:hover:bg-slate-700 transition flex items-center justify-center text-slate-500" aria-label="Medium thumbnails"><i class="fa-solid fa-border-all text-sm"></i></button>
                    <button id="btn-size-l" data-size="large" class="w-8 h-8 rounded hover:bg-white dark:hover:bg-slate-700 transition flex items-center justify-center text-slate-500" aria-label="Large thumbnails"><i class="fa-solid fa-border-all text-lg"></i></button>
                  </div>
                </div>
                <div role="group" aria-label="File info">
                  <div class="flex items-center justify-between cursor-pointer" id="info-toggle" tabindex="0" role="checkbox" aria-checked="false">
                    <span class="text-xs font-medium text-slate-700 dark:text-slate-300">Show File Info</span>
                    <div class="w-8 h-4 bg-slate-200 dark:bg-slate-700 rounded-full relative transition-colors" id="info-toggle-bg">
                      <div class="w-4 h-4 bg-white rounded-full shadow absolute left-0 transition-all transform" id="info-toggle-dot"></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div id="photo-container"></div>
      <div id="empty-state" class="hidden text-center py-32">
        <div class="w-20 h-20 bg-slate-50 dark:bg-slate-800/50 rounded-full flex items-center justify-center mx-auto mb-4 text-slate-300 dark:text-slate-600">
          <i class="fa-regular fa-image text-3xl" aria-hidden="true"></i>
        </div>
        <p class="text-slate-400 dark:text-slate-500 font-medium">It's looking a bit empty here.</p>
      </div>
    </div>
  </main>

  <!-- FOOTER -->
  <footer class="w-full py-8 mt-auto border-t border-slate-200 dark:border-slate-800 text-center">
    <div class="flex flex-col items-center gap-1">
      <span id="global-total-count" class="text-sm font-semibold text-slate-900 dark:text-slate-100">Loading...</span>
      <span class="text-[10px] font-medium text-slate-400 uppercase tracking-wider">Smart Gallery · Premium</span>
    </div>
  </footer>

  <!-- ========== UPLOAD MODAL ========== -->
  <div id="uploadModal" class="fixed inset-0 z-[100] hidden items-center justify-center p-4 bg-black/40 backdrop-blur-sm animate-fade-in" role="dialog" aria-modal="true" aria-label="Upload images and thumbnails">
    <div class="glass-modal rounded-3xl shadow-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto p-6 sm:p-8 transition-all animate-enter">
      <!-- Header -->
      <div class="flex justify-between items-center mb-6">
        <h3 class="text-2xl font-bold text-slate-900 dark:text-white flex items-center gap-3">
          <i class="fa-solid fa-cloud-upload-alt text-blue-500"></i>
          <span>Upload Studio</span>
        </h3>
        <button id="closeUploadModal" class="w-10 h-10 rounded-full bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 dark:hover:bg-slate-700 flex items-center justify-center transition" aria-label="Close modal">
          <i class="fa-solid fa-xmark text-lg"></i>
        </button>
      </div>

      <!-- Tab Navigation -->
      <div class="flex bg-slate-100/80 dark:bg-slate-800/80 rounded-full p-1 mb-8">
        <button id="tabThumbnail" class="upload-tab flex-1 py-2.5 px-4 rounded-full text-sm font-medium transition-all active">Add Thumbnail</button>
        <button id="tabImage" class="upload-tab flex-1 py-2.5 px-4 rounded-full text-sm font-medium transition-all">Upload Image</button>
      </div>

      <!-- Add Thumbnail Panel -->
      <div id="thumbnailPanel" class="space-y-5">
        <div>
          <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-2">Album Name</label>
          <input type="text" id="thumbAlbumName" placeholder="e.g. Maria, Trips, Family" 
                class="w-full px-4 py-3 rounded-xl bg-white/70 dark:bg-slate-900/70 border border-slate-200 dark:border-slate-700 focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 outline-none transition dark:text-white">
          <p class="text-[10px] text-slate-400 mt-1">Enter a new or existing album name.</p>
        </div>
        <div>
          <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-2">Thumbnail Image</label>
          <div class="relative border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-xl p-6 text-center hover:border-blue-500 transition cursor-pointer" id="thumbDropZone">
            <input type="file" id="thumbFileInput" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
            <i class="fa-solid fa-cloud-upload-alt text-3xl text-slate-400 mb-2"></i>
            <p class="text-sm text-slate-600 dark:text-slate-300">Click or drag image</p>
            <p id="thumbFileName" class="text-xs text-blue-500 mt-1 truncate hidden"></p>
          </div>
        </div>
        <button id="uploadThumbBtn" class="w-full py-3.5 bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-500 hover:to-blue-400 text-white font-bold rounded-xl shadow-lg shadow-blue-500/30 transition-all flex items-center justify-center gap-2">
          <i class="fa-solid fa-plus-circle"></i>
          <span>Set as Thumbnail</span>
        </button>
      </div>

      <!-- Upload Image Panel (initially hidden) -->
      <div id="imagePanel" class="space-y-5 hidden">
        <div>
          <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-2">Destination Album</label>
          <input type="text" id="imageAlbumName" placeholder="e.g. Maria, Trips, Family" 
                class="w-full px-4 py-3 rounded-xl bg-white/70 dark:bg-slate-900/70 border border-slate-200 dark:border-slate-700 focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 outline-none transition dark:text-white">
          <p class="text-[10px] text-slate-400 mt-1">Album will be created if it doesn't exist.</p>
        </div>
        <div>
          <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-2">Image File</label>
          <div class="relative border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-xl p-6 text-center hover:border-blue-500 transition cursor-pointer" id="imageDropZone">
            <input type="file" id="imageFileInput" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
            <i class="fa-solid fa-cloud-upload-alt text-3xl text-slate-400 mb-2"></i>
            <p class="text-sm text-slate-600 dark:text-slate-300">Click or drag image</p>
            <p id="imageFileName" class="text-xs text-blue-500 mt-1 truncate hidden"></p>
          </div>
        </div>
        <button id="uploadImageBtn" class="w-full py-3.5 bg-gradient-to-r from-emerald-600 to-emerald-500 hover:from-emerald-500 hover:to-emerald-400 text-white font-bold rounded-xl shadow-lg shadow-emerald-500/30 transition-all flex items-center justify-center gap-2">
          <i class="fa-solid fa-arrow-up-from-bracket"></i>
          <span>Upload to Album</span>
        </button>
      </div>
    </div>
  </div>

  <!-- SUCCESS TOAST -->
  <div id="success-toast" class="fixed bottom-6 left-1/2 -translate-x-1/2 bg-emerald-600/95 text-white px-6 py-3 rounded-full shadow-2xl backdrop-blur-md flex items-center gap-3 transition-all duration-500 translate-y-24 opacity-0 z-[80]" role="status" aria-live="polite">
    <i class="fa-solid fa-check-circle" aria-hidden="true"></i>
    <span class="font-bold text-xs" id="success-msg">Success</span>
  </div>

  <!-- ERROR TOAST -->
  <div id="error-toast" class="fixed top-6 left-1/2 -translate-x-1/2 bg-red-600/95 text-white px-6 py-3 rounded-full shadow-2xl backdrop-blur-md flex items-center gap-3 transition-all duration-500 -translate-y-24 opacity-0 z-[70]" role="alert" aria-live="assertive">
    <i class="fa-solid fa-circle-exclamation" aria-hidden="true"></i>
    <span class="font-bold text-xs" id="error-msg">Error</span>
  </div>

  <!-- LIGHTBOX -->
  <div id="lightbox" class="fixed inset-0 z-50 bg-slate-950/95 backdrop-blur-md hidden flex items-center justify-center opacity-0 transition-opacity duration-300 select-none" role="dialog" aria-modal="true" aria-label="Image lightbox">
    <div class="absolute top-0 left-0 w-full h-1 bg-white/10 z-50"><div id="slideshow-progress" class="h-full bg-blue-500 w-0"></div></div>
    <div id="lb-toolbar" class="absolute top-0 left-0 w-full p-4 flex justify-between items-center z-50 pointer-events-none transition-transform duration-300">
      <span id="lb-counter" class="text-white/80 font-mono text-xs pointer-events-auto bg-white/10 border border-white/10 px-3 py-1.5 rounded-full backdrop-blur-md">1 / 1</span>
      <div class="flex items-center gap-2 pointer-events-auto">
        <button id="lb-play-btn" onclick="window.app?.toggleSlideshow()" class="w-10 h-10 rounded-full bg-white/10 hover:bg-white/20 border border-white/10 text-white transition flex items-center justify-center" aria-label="Start slideshow">
          <i class="fa-solid fa-play text-sm" aria-hidden="true"></i>
        </button>
        <button id="lb-fav-btn" onclick="window.app?.toggleFavoriteCurrent()" class="w-10 h-10 rounded-full bg-white/10 hover:bg-white/20 border border-white/10 text-white transition flex items-center justify-center group" aria-label="Toggle favorite">
          <i class="fa-regular fa-heart text-lg group-hover:scale-110 transition-transform" aria-hidden="true"></i>
        </button>
        <button onclick="window.app?.downloadCurrentImage()" class="w-10 h-10 rounded-full bg-white/10 hover:bg-white/20 border border-white/10 text-white transition flex items-center justify-center" aria-label="Download image">
          <i class="fa-solid fa-download text-sm" aria-hidden="true"></i>
        </button>
        <button onclick="window.app?.closeLightbox()" class="w-10 h-10 rounded-full bg-white/10 hover:bg-white/20 border border-white/10 text-white transition flex items-center justify-center" aria-label="Close lightbox">
          <i class="fa-solid fa-xmark" aria-hidden="true"></i>
        </button>
      </div>
    </div>
    <button id="lb-prev" onclick="window.app?.prevImage()" class="absolute left-3 sm:left-6 top-1/2 -translate-y-1/2 w-12 h-12 sm:w-14 sm:h-14 rounded-full bg-white/10 hover:bg-white/20 border border-white/10 text-white flex items-center justify-center z-50 backdrop-blur-md transition group active:scale-95" aria-label="Previous image">
      <i class="fa-solid fa-chevron-left text-xl group-hover:-translate-x-0.5 transition-transform" aria-hidden="true"></i>
    </button>
    <button id="lb-next" onclick="window.app?.nextImage()" class="absolute right-3 sm:right-6 top-1/2 -translate-y-1/2 w-12 h-12 sm:w-14 sm:h-14 rounded-full bg-white/10 hover:bg-white/20 border border-white/10 text-white flex items-center justify-center z-50 backdrop-blur-md transition group active:scale-95" aria-label="Next image">
      <i class="fa-solid fa-chevron-right text-xl group-hover:translate-x-0.5 transition-transform" aria-hidden="true"></i>
    </button>
    <div class="relative w-full h-full flex items-center justify-center p-4 sm:px-20 transition-all duration-300" id="lb-canvas-container">
      <img id="lightbox-img" crossorigin="anonymous" src="" alt="" class="max-h-full max-w-full object-contain rounded-lg shadow-2xl shadow-black/50 scale-95 transition-transform duration-300 select-none touch-none">
      <video id="lightbox-video" controls class="hidden max-h-full max-w-full rounded-lg shadow-2xl shadow-black/50" aria-label="Video player"></video>
      <div id="lb-caption-container" class="absolute bottom-8 text-center w-full px-12 pointer-events-none transition-opacity duration-300">
        <span id="lightbox-caption" class="inline-block bg-black/40 border border-white/10 text-white/90 px-4 py-2 rounded-full text-xs backdrop-blur-md font-mono truncate max-w-[90%]"></span>
      </div>
    </div>
  </div>

  <script>
    // ==================== SMART GALLERY APP (PREMIUM) ====================
    class SmartGallery {
      constructor() {
        // State
        this.peopleData = {};
        this.thumbnailMap = {};
        this.currentGallery = [];
        this.currentPhotoIndex = 0;
        this.favorites = new Set();
        this.activeView = 'people';
        this.activePerson = null;
        this.slideshowInterval = null;
        this.viewSettings = this.loadViewSettings();
        
        // Paths (for server images)
        this.PATH_TO_IMAGES = 'images/';
        this.PATH_TO_THUMBS = 'thumbnails/';

        // Uploaded images storage (localStorage)
        this.uploadedImages = [];      // array of { filename, dataURL, album, date }
        this.uploadedThumbnails = {};  // album name -> dataURL

        // Bind methods
        this.init = this.init.bind(this);
        this.loadData = this.loadData.bind(this);
        this.loadUploads = this.loadUploads.bind(this);
        this.saveUploads = this.saveUploads.bind(this);
      }

      // ----- INIT -----
      async init() {
        // Dark mode
        if (localStorage.theme === 'dark' || (!localStorage.theme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
          document.documentElement.classList.add('dark');
        }
        // Greeting
        const hour = new Date().getHours();
        document.getElementById('greeting').innerText = hour < 12 ? 'Good morning' : hour < 18 ? 'Good afternoon' : 'Good evening';

        // Load JSON data and uploaded images
        await this.loadData();
        this.loadUploads();
        
        this.loadFavorites();
        this.updateGlobalCount();
        this.renderThumbnails();
        this.renderFavoritesZone();
        this.attachEvents();
        this.setupZoom();
        this.setupUploadModal();

        // Expose app to window for inline handlers
        window.app = this;
      }

      // ----- LOAD JSON (external) -----
      async loadData() {
        try {
          const [fileRes, thumbRes] = await Promise.all([
            fetch('data.json').catch(() => ({ json: () => [] })),
            fetch('thumbnails.json').catch(() => ({ json: () => ({}) }))
          ]);
          const fileList = await fileRes.json();
          this.thumbnailMap = await thumbRes.json();
          // Deduplicate file list
          this.rawFileList = [...new Set(fileList)];
          this.processImages();
        } catch (err) {
          console.warn('Using empty fallback for JSON data');
          this.rawFileList = [];
          this.thumbnailMap = {};
          this.processImages();
        }
      }

      // ----- UPLOAD STORAGE (localStorage) -----
      loadUploads() {
        // Load uploaded images
        const storedImages = localStorage.getItem('sg_uploads_images');
        if (storedImages) {
          this.uploadedImages = JSON.parse(storedImages);
          // Add them to rawFileList (deduped)
          const existing = new Set(this.rawFileList);
          this.uploadedImages.forEach(img => {
            if (!existing.has(img.filename)) {
              this.rawFileList.push(img.filename);
              existing.add(img.filename);
            }
          });
        }
        // Load uploaded thumbnails
        const storedThumbs = localStorage.getItem('sg_uploads_thumbnails');
        if (storedThumbs) {
          this.uploadedThumbnails = JSON.parse(storedThumbs);
          // Merge with thumbnailMap
          Object.assign(this.thumbnailMap, this.uploadedThumbnails);
        }
        this.processImages(); // re-process after merging uploads
      }

      saveUploads() {
        localStorage.setItem('sg_uploads_images', JSON.stringify(this.uploadedImages));
        localStorage.setItem('sg_uploads_thumbnails', JSON.stringify(this.uploadedThumbnails));
        // Update thumbnailMap reference
        Object.assign(this.thumbnailMap, this.uploadedThumbnails);
      }

      // ----- PROCESS IMAGES (build peopleData) -----
      processImages() {
        this.peopleData = {};
        this.rawFileList.forEach(filename => {
          const cleanFile = filename.trim();
          if (!cleanFile) return;
          let namePart = cleanFile.includes('-') ? cleanFile.split('-')[0] : cleanFile.split('_')[0] || '';
          if (!namePart) return;

          let people = namePart.split('+');
          people.forEach(rawName => {
            let cleanName = rawName.trim();
            if (cleanName.length) {
              cleanName = cleanName.charAt(0).toUpperCase() + cleanName.slice(1);
              if (cleanName.toLowerCase() === 'idk') cleanName = 'IDK';
            }
            if (['Img', 'Picsart'].includes(cleanName)) return;
            if (!this.peopleData[cleanName]) this.peopleData[cleanName] = { count: 0, photos: [] };
            this.peopleData[cleanName].count++;
            this.peopleData[cleanName].photos.push(cleanFile);
          });
        });
        document.getElementById('album-count').innerText = `${Object.keys(this.peopleData).length} People`;
      }

      // ----- FAVORITES (unchanged) -----
      loadFavorites() {
        const stored = localStorage.getItem('sg_favorites');
        if (stored) this.favorites = new Set(JSON.parse(stored));
      }
      saveFavorites() {
        localStorage.setItem('sg_favorites', JSON.stringify([...this.favorites]));
        this.renderFavoritesZone();
        if (this.activePerson === 'Favorites') this.showGallery('Favorites');
      }
      toggleFavoriteCurrent() {
        const filename = this.currentGallery[this.currentPhotoIndex];
        const icon = document.querySelector('#lb-fav-btn i');
        if (this.favorites.has(filename)) {
          this.favorites.delete(filename);
          icon.classList.remove('fa-solid', 'text-red-500');
          icon.classList.add('fa-regular');
        } else {
          this.favorites.add(filename);
          icon.classList.remove('fa-regular');
          icon.classList.add('fa-solid', 'text-red-500', 'animate-heart');
          setTimeout(() => icon.classList.remove('animate-heart'), 300);
        }
        this.saveFavorites();
      }

      // ----- HIGH FAVORITES ZONE (unchanged) -----
      renderFavoritesZone() {
        const container = document.getElementById('favorites-zone');
        const scrollEl = document.getElementById('favoritesScroll');
        if (!container || !scrollEl) return;
        const favArray = [...this.favorites];
        if (favArray.length === 0) {
          container.classList.add('hidden');
          return;
        }
        container.classList.remove('hidden');
        const displayFavs = favArray.sort(() => 0.5 - Math.random()).slice(0, 12);
        scrollEl.innerHTML = displayFavs.map(file => {
          const isVideo = file.toLowerCase().endsWith('.mp4');
          // determine if file is uploaded (stored as dataURL) or server image
          const uploaded = this.uploadedImages.find(img => img.filename === file);
          const src = uploaded ? uploaded.dataURL : `${this.PATH_TO_IMAGES}${file}`;
          return `
            <div class="fav-item cursor-pointer" onclick="window.app?.openLightboxFromFile('${file}')" role="button" tabindex="0" aria-label="Favorite photo: ${file}">
              <div class="relative aspect-square rounded-xl overflow-hidden shadow-md hover:shadow-xl transition-all duration-300 hover:scale-[1.02] bg-slate-200 dark:bg-slate-800">
                ${isVideo ? 
                  `<video src="${src}" class="w-full h-full object-cover"></video>
                   <div class="absolute top-1 right-1 bg-black/50 text-white w-5 h-5 rounded-full flex items-center justify-center text-[10px] backdrop-blur-sm"><i class="fa-solid fa-play"></i></div>` :
                  `<img src="${src}" loading="lazy" alt="" class="w-full h-full object-cover img-loading" onload="this.classList.remove('img-loading'); this.classList.add('img-loaded');">`
                }
                <div class="absolute inset-0 bg-gradient-to-t from-black/30 to-transparent opacity-0 hover:opacity-100 transition-opacity"></div>
              </div>
            </div>
          `;
        }).join('');
        document.getElementById('viewAllFavorites').onclick = () => this.showGallery('Favorites');
      }

      // ----- THUMBNAIL URL (supports uploaded thumbnails) -----
      getThumbUrl(name) {
        // If we have an uploaded thumbnail dataURL, return it directly
        if (this.uploadedThumbnails[name]) {
          return this.uploadedThumbnails[name];
        }
        let thumbSrc = `${this.PATH_TO_THUMBS}${name}.jpg`;
        if (this.thumbnailMap[name]) thumbSrc = `${this.PATH_TO_THUMBS}${this.thumbnailMap[name]}`;
        return thumbSrc;
      }

      // ----- RENDER ALBUMS (unchanged, but uses getThumbUrl) -----
      renderThumbnails(filter = '') {
        const grid = document.getElementById('people-grid');
        grid.innerHTML = '';
        const allVisible = this.getAllVisiblePhotos();

        if (!filter || 'all photos'.includes(filter)) {
          grid.appendChild(this.createAlbumCard('All Photos', allVisible.length, 'layer-group', 'from-blue-500 to-cyan-500'));
        }
        if (!filter || 'favorites'.includes(filter)) {
          const favCount = [...this.favorites].filter(f => allVisible.includes(f)).length;
          grid.appendChild(this.createAlbumCard('Favorites', favCount, 'heart', 'from-pink-500 to-rose-600'));
        }

        const sortedNames = Object.keys(this.peopleData).sort();
        let hasResults = false;

        sortedNames.forEach(name => {
          if (filter && !name.toLowerCase().includes(filter)) return;
          hasResults = true;
          const data = this.peopleData[name];
          const card = document.createElement('div');
          card.className = 'group relative overflow-hidden rounded-2xl aspect-[4/5] cursor-pointer shadow-sm hover:shadow-xl transition-all duration-500 hover:-translate-y-1 bg-slate-200 dark:bg-slate-800';
          card.onclick = () => this.showGallery(name);
          card.setAttribute('aria-label', `Album ${name}, ${data.count} photos`);

          const thumbUrl = this.getThumbUrl(name);
          const img = document.createElement('img');
          img.src = thumbUrl;
          img.loading = 'lazy';
          img.alt = `Album cover for ${name}`;
          img.className = 'absolute inset-0 w-full h-full object-cover transition duration-700 group-hover:scale-110 img-loading';
          img.onload = function() { this.classList.remove('img-loading'); this.classList.add('img-loaded'); };
          img.onerror = () => { img.src = `https://ui-avatars.com/api/?name=${name}&background=random`; };

          const overlay = document.createElement('div');
          overlay.className = 'absolute inset-0 bg-gradient-to-t from-black/80 via-black/20 to-transparent opacity-80 group-hover:opacity-90 transition-opacity';

          const info = document.createElement('div');
          info.className = 'absolute bottom-0 left-0 p-4 w-full translate-y-1 group-hover:translate-y-0 transition-transform duration-300';
          info.innerHTML = `
            <h3 class="text-white text-lg font-bold tracking-wide truncate leading-tight">${name}</h3>
            <span class="inline-block px-2 py-0.5 bg-white/20 backdrop-blur-sm rounded-full text-[9px] font-medium text-white border border-white/10">${data.count} Photos</span>
          `;

          card.appendChild(img);
          card.appendChild(overlay);
          card.appendChild(info);
          grid.appendChild(card);
        });

        const hasSpecial = !filter || 'favorites'.includes(filter) || 'all photos'.includes(filter);
        document.getElementById('no-albums').classList.toggle('hidden', hasResults || hasSpecial);
      }

      createAlbumCard(name, count, icon, gradient) {
        const card = document.createElement('div');
        card.className = `group relative overflow-hidden rounded-2xl aspect-[4/5] cursor-pointer shadow-md hover:shadow-xl transition-all duration-500 hover:-translate-y-1 bg-gradient-to-br ${gradient}`;
        card.onclick = () => this.showGallery(name);
        card.setAttribute('aria-label', `${name} album, ${count} photos`);
        card.innerHTML = `
          <div class="absolute inset-0 flex items-center justify-center text-white/90 group-hover:scale-110 transition-transform duration-700">
            <i class="fa-solid fa-${icon} text-6xl drop-shadow-lg" aria-hidden="true"></i>
          </div>
          <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent"></div>
          <div class="absolute bottom-0 left-0 p-4 w-full">
            <h3 class="text-white text-lg font-bold tracking-wide">${name}</h3>
            <p class="text-white/80 text-xs font-medium">${count} Photos</p>
          </div>
        `;
        return card;
      }

      // ----- GALLERY VIEW (uses uploaded images too) -----
      showGallery(name, filter = '') {
        this.activePerson = name;
        this.activeView = 'gallery';
        
        document.getElementById('header-name').innerText = name;
        const avatarImg = document.getElementById('header-avatar');
        const avatarIcon = document.getElementById('header-icon');
        const headerContainer = document.getElementById('header-avatar-container');

        let displayPhotos = [];
        if (name === 'Favorites') {
          displayPhotos = this.getAllVisiblePhotos().filter(f => this.favorites.has(f));
          document.getElementById('header-count').innerText = `${displayPhotos.length} Saved`;
          avatarImg.classList.add('hidden');
          avatarIcon.classList.remove('hidden');
          avatarIcon.className = 'fa-solid fa-heart text-rose-500 text-lg';
          headerContainer.className = 'w-10 h-10 rounded-full shadow-sm ring-2 ring-white dark:ring-slate-700 flex items-center justify-center bg-rose-100 dark:bg-rose-900/30';
        } else if (name === 'All Photos') {
          displayPhotos = this.getAllVisiblePhotos();
          document.getElementById('header-count').innerText = `${displayPhotos.length} Total`;
          avatarImg.classList.add('hidden');
          avatarIcon.classList.remove('hidden');
          avatarIcon.className = 'fa-solid fa-layer-group text-blue-500 text-lg';
          headerContainer.className = 'w-10 h-10 rounded-full shadow-sm ring-2 ring-white dark:ring-slate-700 flex items-center justify-center bg-blue-100 dark:bg-blue-900/30';
        } else {
          const data = this.peopleData[name];
          displayPhotos = data.photos;
          document.getElementById('header-count').innerText = `${data.count} Photos`;
          const thumbSrc = this.getThumbUrl(name);
          avatarImg.src = thumbSrc;
          avatarImg.alt = `Avatar of ${name}`;
          avatarImg.classList.remove('hidden');
          avatarIcon.classList.add('hidden');
          headerContainer.className = 'w-10 h-10 rounded-full overflow-hidden shadow-sm ring-2 ring-white dark:ring-slate-700 bg-slate-100 dark:bg-slate-800';
        }

        if (filter) displayPhotos = displayPhotos.filter(f => f.toLowerCase().includes(filter));
        this.currentGallery = displayPhotos;
        this.renderActiveGalleryContent();

        document.getElementById('people-view').classList.add('hidden');
        const galleryView = document.getElementById('gallery-view');
        galleryView.classList.remove('hidden', 'animate-enter');
        void galleryView.offsetWidth;
        galleryView.classList.add('animate-enter');
        window.scrollTo(0, 0);
      }

      // ----- RENDER GALLERY (supports dataURL for uploaded images) -----
      renderActiveGalleryContent() {
        const container = document.getElementById('photo-container');
        container.innerHTML = '';
        if (this.currentGallery.length === 0) {
          document.getElementById('empty-state').classList.remove('hidden');
          return;
        }
        document.getElementById('empty-state').classList.add('hidden');

        let gridClass = '', squareGridClass = '';
        if (this.viewSettings.size === 'small') {
          gridClass = 'columns-2 sm:columns-4 lg:columns-6 gap-4';
          squareGridClass = 'grid-cols-3 sm:grid-cols-5 lg:grid-cols-7 gap-1';
        } else if (this.viewSettings.size === 'large') {
          gridClass = 'columns-1 sm:columns-2 lg:columns-3 gap-6';
          squareGridClass = 'grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4';
        } else {
          gridClass = 'columns-2 sm:columns-3 lg:columns-4 gap-4';
          squareGridClass = 'grid-cols-3 sm:grid-cols-4 lg:grid-cols-5 gap-1';
        }

        const grid = document.createElement('div');
        if (this.viewSettings.type === 'square') {
          grid.className = `grid ${squareGridClass}`;
        } else {
          grid.className = gridClass;
        }

        this.currentGallery.forEach((filename, index) => {
          grid.appendChild(this.createPhotoCard(filename, index, this.viewSettings.type === 'square'));
        });
        container.appendChild(grid);
      }

      createPhotoCard(filename, index, isSquare = false) {
        const wrapper = document.createElement('div');
        const mb = isSquare ? '' : 'mb-4';
        const className = isSquare
          ? `group relative aspect-square overflow-hidden cursor-zoom-in bg-slate-200 dark:bg-slate-800 ${mb}`
          : `masonry-item break-inside-avoid group relative rounded-xl overflow-hidden cursor-zoom-in bg-slate-200 dark:bg-slate-800 shadow-sm hover:shadow-md transition-all ${mb}`;
        wrapper.className = className;
        wrapper.onclick = (e) => {
          e.stopPropagation();
          this.openLightbox(index);
        };
        wrapper.setAttribute('aria-label', `Photo ${index + 1} of ${this.currentGallery.length}`);

        // Determine source (uploaded or server)
        const uploaded = this.uploadedImages.find(img => img.filename === filename);
        const src = uploaded ? uploaded.dataURL : `${this.PATH_TO_IMAGES}${filename}`;

        if (filename.toLowerCase().endsWith('.mp4')) {
          const video = document.createElement('video');
          video.src = src;
          video.className = 'w-full h-full object-cover pointer-events-none';
          wrapper.appendChild(video);
          const icon = document.createElement('div');
          icon.className = 'absolute top-2 right-2 bg-black/50 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs backdrop-blur-sm';
          icon.innerHTML = '<i class="fa-solid fa-play"></i>';
          wrapper.appendChild(icon);
        } else {
          const img = document.createElement('img');
          img.src = src;
          img.loading = 'lazy';
          img.alt = '';
          img.className = 'w-full h-full object-cover transition duration-700 group-hover:scale-110 img-loading';
          img.onload = function() { this.classList.remove('img-loading'); this.classList.add('img-loaded'); };
          wrapper.appendChild(img);
        }

        if (this.viewSettings.showInfo) {
          const info = document.createElement('div');
          info.className = 'absolute bottom-0 left-0 w-full p-2 bg-gradient-to-t from-black/80 to-transparent pointer-events-none';
          const date = this.extractDate(filename);
          const dateStr = date.getTime() !== 0 ? date.toLocaleDateString() : '';
          info.innerHTML = `
            <p class="text-white text-[10px] font-mono truncate opacity-90">${filename}</p>
            ${dateStr ? `<p class="text-white/60 text-[9px] font-medium">${dateStr}</p>` : ''}
          `;
          wrapper.appendChild(info);
        }

        return wrapper;
      }

      // ----- LIGHTBOX (supports dataURL) -----
      openLightbox(index) {
        this.currentPhotoIndex = index;
        this.updateLightboxContent();
        const lightbox = document.getElementById('lightbox');
        const lbImg = document.getElementById('lightbox-img');
        lightbox.classList.remove('hidden');
        setTimeout(() => {
          lightbox.classList.remove('opacity-0');
          lbImg.classList.remove('scale-95');
        }, 10);
      }
      updateLightboxContent() {
        if (this.currentGallery.length === 0) return;
        const filename = this.currentGallery[this.currentPhotoIndex];
        const uploaded = this.uploadedImages.find(img => img.filename === filename);
        const src = uploaded ? uploaded.dataURL : `${this.PATH_TO_IMAGES}${filename}`;
        
        const favIcon = document.querySelector('#lb-fav-btn i');
        if (this.favorites.has(filename)) {
          favIcon.classList.remove('fa-regular');
          favIcon.classList.add('fa-solid', 'text-red-500');
        } else {
          favIcon.classList.remove('fa-solid', 'text-red-500');
          favIcon.classList.add('fa-regular');
        }

        document.getElementById('lightbox-caption').innerText = filename;
        document.getElementById('lb-counter').innerText = `${this.currentPhotoIndex + 1} / ${this.currentGallery.length}`;
        const lbImg = document.getElementById('lightbox-img');
        const lbVideo = document.getElementById('lightbox-video');
        lbImg.classList.add('hidden');
        lbVideo.classList.add('hidden');
        lbVideo.pause();

        if (filename.toLowerCase().endsWith('.mp4')) {
          lbVideo.classList.remove('hidden');
          lbVideo.src = src;
          lbVideo.play();
        } else {
          lbImg.classList.remove('hidden');
          lbImg.src = src;
          lbImg.alt = filename;
          lbImg.style.filter = '';
          lbImg.style.transform = '';
        }
      }

      // ----- ALL VISIBLE PHOTOS (server + uploaded) -----
      getAllVisiblePhotos() {
        return this.rawFileList;
      }

      // ----- OPEN LIGHTBOX FROM FILENAME -----
      openLightboxFromFile(filename) {
        this.currentGallery = this.getAllVisiblePhotos();
        const idx = this.currentGallery.indexOf(filename);
        if (idx !== -1) this.openLightbox(idx);
      }

      // ----- UPLOAD MODAL SETUP -----
      setupUploadModal() {
        const modal = document.getElementById('uploadModal');
        const openBtn = document.getElementById('uploadBtn');
        const closeBtn = document.getElementById('closeUploadModal');
        const tabThumb = document.getElementById('tabThumbnail');
        const tabImage = document.getElementById('tabImage');
        const thumbPanel = document.getElementById('thumbnailPanel');
        const imagePanel = document.getElementById('imagePanel');

        // Open modal
        openBtn.addEventListener('click', () => {
          modal.classList.remove('hidden');
          modal.classList.add('flex');
        });

        // Close modal
        const closeModal = () => {
          modal.classList.add('hidden');
          modal.classList.remove('flex');
          // Reset inputs
          document.getElementById('thumbAlbumName').value = '';
          document.getElementById('thumbFileName').classList.add('hidden');
          document.getElementById('thumbFileInput').value = '';
          document.getElementById('imageAlbumName').value = '';
          document.getElementById('imageFileName').classList.add('hidden');
          document.getElementById('imageFileInput').value = '';
        };
        closeBtn.addEventListener('click', closeModal);
        modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });

        // Tab switching
        tabThumb.addEventListener('click', () => {
          tabThumb.classList.add('active');
          tabImage.classList.remove('active');
          thumbPanel.classList.remove('hidden');
          imagePanel.classList.add('hidden');
        });
        tabImage.addEventListener('click', () => {
          tabImage.classList.add('active');
          tabThumb.classList.remove('active');
          imagePanel.classList.remove('hidden');
          thumbPanel.classList.add('hidden');
        });

        // File input previews
        const thumbFile = document.getElementById('thumbFileInput');
        const thumbFileName = document.getElementById('thumbFileName');
        thumbFile.addEventListener('change', () => {
          if (thumbFile.files[0]) {
            thumbFileName.textContent = thumbFile.files[0].name;
            thumbFileName.classList.remove('hidden');
          }
        });
        const imageFile = document.getElementById('imageFileInput');
        const imageFileName = document.getElementById('imageFileName');
        imageFile.addEventListener('change', () => {
          if (imageFile.files[0]) {
            imageFileName.textContent = imageFile.files[0].name;
            imageFileName.classList.remove('hidden');
          }
        });

        // Upload Thumbnail
        document.getElementById('uploadThumbBtn').addEventListener('click', () => this.handleThumbnailUpload());
        // Upload Image
        document.getElementById('uploadImageBtn').addEventListener('click', () => this.handleImageUpload());
      }

      // ----- HANDLE THUMBNAIL UPLOAD -----
      async handleThumbnailUpload() {
        const album = document.getElementById('thumbAlbumName').value.trim();
        const fileInput = document.getElementById('thumbFileInput');
        if (!album) return this.showError('Please enter an album name.');
        if (!fileInput.files[0]) return this.showError('Please select an image.');

        const file = fileInput.files[0];
        if (!file.type.startsWith('image/')) return this.showError('Only image files are allowed.');

        try {
          const dataURL = await this.readFileAsDataURL(file);
          // Store uploaded thumbnail
          this.uploadedThumbnails[album] = dataURL;
          this.saveUploads();

          // Show success
          this.showSuccess(`Thumbnail for "${album}" updated.`);
          // Re-render albums
          this.renderThumbnails();
          // Close modal
          document.getElementById('closeUploadModal').click();
        } catch (err) {
          this.showError('Failed to read image.');
        }
      }

      // ----- HANDLE IMAGE UPLOAD -----
      async handleImageUpload() {
        const album = document.getElementById('imageAlbumName').value.trim();
        const fileInput = document.getElementById('imageFileInput');
        if (!album) return this.showError('Please enter an album name.');
        if (!fileInput.files[0]) return this.showError('Please select an image.');

        const file = fileInput.files[0];
        if (!file.type.startsWith('image/')) return this.showError('Only image files are allowed.');

        try {
          const dataURL = await this.readFileAsDataURL(file);
          // Generate unique filename
          const timestamp = Date.now();
          const random = Math.floor(Math.random() * 1000);
          const extension = file.name.split('.').pop() || 'jpg';
          const filename = `${album}-${timestamp}-${random}.${extension}`;

          // Store uploaded image
          this.uploadedImages.push({
            filename,
            dataURL,
            album,
            date: new Date().toISOString()
          });
          this.saveUploads();

          // Add to rawFileList and reprocess
          this.rawFileList.push(filename);
          this.processImages();

          this.showSuccess(`Image added to "${album}".`);
          // Close modal
          document.getElementById('closeUploadModal').click();

          // If currently viewing this album, refresh gallery
          if (this.activePerson === album) {
            this.showGallery(album);
          } else {
            this.renderThumbnails();
          }
          this.updateGlobalCount();
          this.renderFavoritesZone();
        } catch (err) {
          this.showError('Failed to read image.');
        }
      }

      readFileAsDataURL(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.onerror = reject;
          reader.readAsDataURL(file);
        });
      }

      // ----- VIEW SETTINGS (unchanged) -----
      loadViewSettings() {
        const stored = localStorage.getItem('sg_view_settings');
        const defaults = { type: 'masonry', size: 'medium', showInfo: false };
        if (stored) return { ...defaults, ...JSON.parse(stored) };
        return defaults;
      }
      saveViewSettings() {
        localStorage.setItem('sg_view_settings', JSON.stringify(this.viewSettings));
        this.updateViewSettingsUI();
        if (this.activeView === 'gallery') this.renderActiveGalleryContent();
      }
      updateViewSettingsUI() { /* ... same as before ... */
        ['masonry','square'].forEach(t=>{let btn=document.getElementById(`btn-${t}`);if(this.viewSettings.type===t){btn?.classList.add('bg-white','text-blue-600','shadow-sm','dark:bg-slate-700','dark:text-blue-400');btn?.classList.remove('text-slate-500');}else{btn?.classList.remove('bg-white','text-blue-600','shadow-sm','dark:bg-slate-700','dark:text-blue-400');btn?.classList.add('text-slate-500');}});
        ['s','m','l'].forEach(s=>{let sizeName=s==='s'?'small':s==='m'?'medium':'large';let btn=document.getElementById(`btn-size-${s}`);if(this.viewSettings.size===sizeName){btn?.classList.add('bg-white','text-blue-600','shadow-sm','dark:bg-slate-700','dark:text-blue-400');btn?.classList.remove('text-slate-500','hover:bg-white','dark:hover:bg-slate-700');}else{btn?.classList.remove('bg-white','text-blue-600','shadow-sm','dark:bg-slate-700','dark:text-blue-400');btn?.classList.add('text-slate-500','hover:bg-white','dark:hover:bg-slate-700');}});
        let dot=document.getElementById('info-toggle-dot'),bg=document.getElementById('info-toggle-bg');
        if(this.viewSettings.showInfo){dot.style.transform='translateX(100%)';bg.classList.add('bg-blue-500');bg.classList.remove('bg-slate-200','dark:bg-slate-700');document.getElementById('info-toggle')?.setAttribute('aria-checked','true');}
        else{dot.style.transform='translateX(0)';bg.classList.remove('bg-blue-500');bg.classList.add('bg-slate-200','dark:bg-slate-700');document.getElementById('info-toggle')?.setAttribute('aria-checked','false');}
      }

      // ----- EXTRACT DATE (unchanged) -----
      extractDate(filename) {
        const match = filename.match(/(20\d{2})[-_]?((?:0[1-9]|1[0-2]))[-_]?((?:0[1-9]|[12][0-9]|3[01]))/);
        if (match) return new Date(match[1], match[2]-1, match[3]);
        return new Date(0);
      }

      // ----- ZOOM GESTURES (unchanged) -----
      setupZoom() { /* ... (same as before) ... */
        const img = document.getElementById('lightbox-img');
        let startDist = 0, startCenter = { x:0, y:0 }, isZooming = false;
        img.addEventListener('touchstart',(e)=>{if(e.touches.length===2){e.preventDefault();isZooming=true;const dx=e.touches[0].clientX-e.touches[1].clientX,dy=e.touches[0].clientY-e.touches[1].clientY;startDist=Math.hypot(dx,dy);startCenter={x:(e.touches[0].clientX+e.touches[1].clientX)/2,y:(e.touches[0].clientY+e.touches[1].clientY)/2};const rect=img.getBoundingClientRect();img.style.transition='none';img.style.transformOrigin=`${startCenter.x-rect.left}px ${startCenter.y-rect.top}px`;}});
        img.addEventListener('touchmove',(e)=>{if(!isZooming||e.touches.length!==2)return;e.preventDefault();const dx=e.touches[0].clientX-e.touches[1].clientX,dy=e.touches[0].clientY-e.touches[1].clientY,newDist=Math.hypot(dx,dy),scale=Math.max(1,newDist/startDist),cx=(e.touches[0].clientX+e.touches[1].clientX)/2,cy=(e.touches[0].clientY+e.touches[1].clientY)/2,tx=cx-startCenter.x,ty=cy-startCenter.y;img.style.transform=`translate(${tx}px, ${ty}px) scale(${scale})`;});
        img.addEventListener('touchend',(e)=>{if(isZooming&&e.touches.length<2){isZooming=false;img.style.transition='transform 0.3s cubic-bezier(0.2,0,0.2,1)';img.style.transform='';setTimeout(()=>{if(!isZooming)img.style.transformOrigin='center';},300);}});
      }

      // ----- UTILS -----
      showError(msg) {
        const toast = document.getElementById('error-toast');
        document.getElementById('error-msg').innerText = msg;
        toast.classList.remove('-translate-y-24', 'opacity-0');
        setTimeout(() => toast.classList.add('-translate-y-24', 'opacity-0'), 5000);
      }
      showSuccess(msg) {
        const toast = document.getElementById('success-toast');
        document.getElementById('success-msg').innerText = msg;
        toast.classList.remove('translate-y-24', 'opacity-0');
        setTimeout(() => toast.classList.add('translate-y-24', 'opacity-0'), 3000);
      }
      updateGlobalCount() {
        document.getElementById('global-total-count').innerText = `${this.rawFileList?.length || 0} Photos · ${this.favorites.size} Favorites`;
      }
      goBack() {
        this.activePerson = null;
        this.activeView = 'people';
        document.getElementById('gallery-view').classList.add('hidden');
        const peopleView = document.getElementById('people-view');
        peopleView.classList.remove('hidden');
        peopleView.classList.remove('animate-enter');
        void peopleView.offsetWidth;
        peopleView.classList.add('animate-enter');
        document.getElementById('searchInput').value = '';
        this.renderThumbnails();
      }

      // ----- EVENT LISTENERS (unchanged, but added missing ones) -----
      attachEvents() {
        document.getElementById('themeToggle').addEventListener('click',()=>{document.documentElement.classList.toggle('dark');localStorage.theme=document.documentElement.classList.contains('dark')?'dark':'light';});
        document.getElementById('searchInput').addEventListener('input',(e)=>{let q=e.target.value.toLowerCase().trim();if(!document.getElementById('people-view').classList.contains('hidden'))this.renderThumbnails(q);else if(this.activePerson)this.showGallery(this.activePerson,q);});
        document.getElementById('backButton').addEventListener('click',()=>this.goBack());
        const settingsBtn=document.getElementById('settings-btn'),dropdown=document.getElementById('view-settings-dropdown');
        settingsBtn.addEventListener('click',(e)=>{e.stopPropagation();let exp=settingsBtn.getAttribute('aria-expanded')==='true'?false:true;settingsBtn.setAttribute('aria-expanded',exp);dropdown.classList.toggle('hidden');});
        document.addEventListener('click',(e)=>{if(!dropdown.classList.contains('hidden')&&!dropdown.contains(e.target)&&!settingsBtn.contains(e.target)){dropdown.classList.add('hidden');settingsBtn.setAttribute('aria-expanded','false');}});
        document.getElementById('btn-masonry').addEventListener('click',()=>{this.viewSettings.type='masonry';this.saveViewSettings();});
        document.getElementById('btn-square').addEventListener('click',()=>{this.viewSettings.type='square';this.saveViewSettings();});
        document.getElementById('btn-size-s').addEventListener('click',()=>{this.viewSettings.size='small';this.saveViewSettings();});
        document.getElementById('btn-size-m').addEventListener('click',()=>{this.viewSettings.size='medium';this.saveViewSettings();});
        document.getElementById('btn-size-l').addEventListener('click',()=>{this.viewSettings.size='large';this.saveViewSettings();});
        const infoToggle=document.getElementById('info-toggle');
        infoToggle.addEventListener('click',()=>{this.viewSettings.showInfo=!this.viewSettings.showInfo;this.saveViewSettings();});
        infoToggle.addEventListener('keydown',(e)=>{if(e.key==='Enter'||e.key===' '){e.preventDefault();this.viewSettings.showInfo=!this.viewSettings.showInfo;this.saveViewSettings();}});
        document.addEventListener('keydown',(e)=>{let lb=document.getElementById('lightbox');if(lb.classList.contains('hidden'))return;if(e.key==='Escape')this.closeLightbox();if(e.key==='ArrowRight')this.nextImage();if(e.key==='ArrowLeft')this.prevImage();});
        document.getElementById('lightbox').addEventListener('click',(e)=>{if(e.target===document.getElementById('lightbox'))this.closeLightbox();});
        this.updateViewSettingsUI();
      }

      // ----- LIGHTBOX NAVIGATION (shortcuts) -----
      nextImage() { this.currentPhotoIndex = (this.currentPhotoIndex < this.currentGallery.length - 1) ? this.currentPhotoIndex + 1 : 0; this.updateLightboxContent(); }
      prevImage() { this.currentPhotoIndex = (this.currentPhotoIndex > 0) ? this.currentPhotoIndex - 1 : this.currentGallery.length - 1; this.updateLightboxContent(); }
      closeLightbox() { if (this.slideshowInterval) this.toggleSlideshow(); const lb=document.getElementById('lightbox'), img=document.getElementById('lightbox-img'); lb.classList.add('opacity-0'); img.classList.add('scale-95'); setTimeout(()=>{ lb.classList.add('hidden'); document.getElementById('lightbox-video').pause(); },300); }
      toggleSlideshow() { /* ... same as before ... */
        const btn=document.querySelector('#lb-play-btn i'), bar=document.getElementById('slideshow-progress');
        if(this.slideshowInterval){clearInterval(this.slideshowInterval);this.slideshowInterval=null;btn.classList.remove('fa-pause');btn.classList.add('fa-play');bar.classList.remove('animate-progress');bar.style.width='0';}
        else{btn.classList.remove('fa-play');btn.classList.add('fa-pause');this.nextImage();bar.classList.add('animate-progress');this.slideshowInterval=setInterval(()=>{bar.classList.remove('animate-progress');void bar.offsetWidth;bar.classList.add('animate-progress');this.nextImage();},3000);}
      }
      downloadCurrentImage() {
        const filename = this.currentGallery[this.currentPhotoIndex];
        const uploaded = this.uploadedImages.find(img => img.filename === filename);
        const src = uploaded ? uploaded.dataURL : `${this.PATH_TO_IMAGES}${filename}`;
        const link = document.createElement('a');
        link.href = src;
        link.download = filename;
        link.target = '_blank';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }
    }

    // Start the app
    window.addEventListener('load', () => {
      const app = new SmartGallery();
      app.init();
    });
  </script>
  <!-- Service Worker Registration -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js')
          .then(reg => console.log('Service Worker registered:', reg))
          .catch(err => console.log('Service Worker registration failed:', err));
      });
    }
  </script>
</body>
</html>