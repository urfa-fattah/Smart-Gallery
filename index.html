<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>Smart Gallery Â· Hidden Vault</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#3b82f6">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="icon.png">
  
  <!-- Tailwind + Inter + Font Awesome -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  
  <!-- React & ReactDOM (UMD) -->
  <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
  
  <!-- Babel Standalone for JSX -->
  <script src="https://unpkg.com/@babel/standalone@7.22.5/babel.min.js"></script>
  
  <style>
    body { font-family: 'Inter', sans-serif; -webkit-font-smoothing: antialiased; }
    
    /* ðŸ”· SOLID GLASS â€“ NO TRANSFERENCE */
    .glass-nav { 
      background: rgba(255,255,255,0.92); 
      backdrop-filter: blur(10px); 
      border-bottom: 1px solid rgba(0,0,0,0.06); 
      box-shadow: 0 4px 20px -6px rgba(0,0,0,0.02);
    }
    .dark .glass-nav { 
      background: rgba(15,23,42,0.92); 
      border-bottom: 1px solid rgba(255,255,255,0.06); 
    }
    
    .glass-modal {
      background: rgba(255,255,255,0.96);
      backdrop-filter: blur(16px);
      border: 1px solid rgba(255,255,255,0.4);
      box-shadow: 0 20px 35px -8px rgba(0,0,0,0.15);
    }
    .dark .glass-modal {
      background: rgba(15,23,42,0.96);
      border: 1px solid rgba(255,255,255,0.08);
    }

    .glass-card { 
      background: rgba(255,255,255,0.85); 
      backdrop-filter: blur(12px); 
      border: 1px solid rgba(255,255,255,0.3); 
    }
    .dark .glass-card { 
      background: rgba(15,23,42,0.85); 
      border: 1px solid rgba(255,255,255,0.05); 
    }
    
    .img-loading { opacity: 0; transform: scale(1.05); filter: blur(10px); }
    .img-loaded { opacity: 1; transform: scale(1); filter: blur(0); transition: all 0.7s cubic-bezier(0.4,0,0.2,1); }
    .animate-enter { animation: fadeSlideUp 0.5s cubic-bezier(0.16,1,0.3,1) forwards; }
    @keyframes fadeSlideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    
    /* Progress bar for slideshow */
    @keyframes progress { from { width: 0%; } to { width: 100%; } }
    .animate-progress { animation: progress 3s linear forwards; }
    
    /* Zoom & pan container */
    .zoom-container {
      cursor: grab;
      transition: transform 0.1s ease;
    }
    .zoom-container.dragging { cursor: grabbing; }
    .zoom-content {
      transform-origin: center center;
      will-change: transform;
    }
    
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    .dark ::-webkit-scrollbar-thumb { background: #334155; }
    
    .favorites-zone { display: flex; gap: 1rem; overflow-x: auto; scroll-snap-type: x mandatory; padding-bottom: 0.5rem; }
    .favorites-zone .fav-item { flex: 0 0 120px; scroll-snap-align: start; }
    @media (min-width: 640px) { .favorites-zone .fav-item { flex-basis: 150px; } }
    
    .backup-code { font-family: monospace; background: rgba(59,130,246,0.1); padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; }
    
    .photo-action-btn {
      opacity: 0.8;
      transition: opacity 0.2s, transform 0.1s;
    }
    .photo-action-btn:hover {
      opacity: 1;
      transform: scale(1.05);
    }
  </style>
</head>
<body class="bg-slate-50 text-slate-900 dark:bg-slate-950 dark:text-slate-100 transition-colors duration-500">
  <div id="root" class="flex flex-col min-h-screen"></div>

  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js')
          .then(reg => console.log('SW registered:', reg))
          .catch(err => console.log('SW failed:', err));
      });
    }
  </script>

  <script type="text/babel" data-type="module">
    const { useState, useEffect, useCallback, useRef, createContext, useContext, useMemo } = React;

    // ---------- INDEXED DB â€“ FIX FOR QUOTA & PERSISTENCE (no clear overwrite) ----------
    const DB_NAME = 'SmartGalleryDB';
    const DB_VERSION = 2;
    const STORE_IMAGES = 'uploadedImages';
    const STORE_THUMBS = 'uploadedThumbnails';

    function openDB() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, DB_VERSION);
        request.onerror = () => reject(request.error);
        request.onsuccess = () => resolve(request.result);
        request.onupgradeneeded = (e) => {
          const db = e.target.result;
          if (!db.objectStoreNames.contains(STORE_IMAGES)) {
            db.createObjectStore(STORE_IMAGES, { keyPath: 'filename' });
          }
          if (!db.objectStoreNames.contains(STORE_THUMBS)) {
            db.createObjectStore(STORE_THUMBS, { keyPath: 'album' });
          }
        };
      });
    }

    async function getAllFromStore(storeName) {
      const db = await openDB();
      return new Promise((resolve, reject) => {
        const tx = db.transaction(storeName, 'readonly');
        const store = tx.objectStore(storeName);
        const request = store.getAll();
        request.onerror = () => reject(request.error);
        request.onsuccess = () => resolve(request.result);
        tx.oncomplete = () => db.close();
      });
    }

    async function putItemInStore(storeName, item) {
      const db = await openDB();
      return new Promise((resolve, reject) => {
        const tx = db.transaction(storeName, 'readwrite');
        const store = tx.objectStore(storeName);
        store.put(item);
        tx.oncomplete = () => { db.close(); resolve(); };
        tx.onerror = () => { db.close(); reject(tx.error); };
      });
    }

    async function removeItemFromStore(storeName, key) {
      const db = await openDB();
      return new Promise((resolve, reject) => {
        const tx = db.transaction(storeName, 'readwrite');
        const store = tx.objectStore(storeName);
        store.delete(key);
        tx.oncomplete = () => { db.close(); resolve(); };
        tx.onerror = () => { db.close(); reject(tx.error); };
      });
    }

    async function putAllInStore(storeName, items) {
      if (!items || items.length === 0) return;
      const db = await openDB();
      return new Promise((resolve, reject) => {
        const tx = db.transaction(storeName, 'readwrite');
        const store = tx.objectStore(storeName);
        for (const item of items) store.put(item);
        tx.oncomplete = () => { db.close(); resolve(); };
        tx.onerror = () => { db.close(); reject(tx.error); };
      });
    }

    // ---------- UTILS ----------
    const PATH_TO_IMAGES = 'images/';
    const PATH_TO_THUMBS = 'thumbnails/';

    async function hashString(str) {
      const encoder = new TextEncoder();
      const data = encoder.encode(str);
      const hashBuffer = await crypto.subtle.digest('SHA-256', data);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    }

    // ---------- GLOBAL APP CONTEXT ----------
    const AppContext = createContext();

    // ---------- MAIN APP COMPONENT ----------
    function App() {
      // ----- PERSISTENT STATE -----
      const [rawFileList, setRawFileList] = useState([]);
      const [thumbnailMap, setThumbnailMap] = useState({});
      const [uploadedImages, setUploadedImages] = useState([]);
      const [uploadedThumbnails, setUploadedThumbnails] = useState({});
      const [favorites, setFavorites] = useState(new Set());
      const [deletedImages, setDeletedImages] = useState([]);
      const [hiddenAlbums, setHiddenAlbums] = useState({});
      const [viewSettings, setViewSettings] = useState(() => {
        const stored = localStorage.getItem('sg_view_settings');
        return stored ? JSON.parse(stored) : { type: 'masonry', size: 'medium', showInfo: false };
      });
      const [albumSortOrder, setAlbumSortOrder] = useState('asc');

      // ----- HIDDEN PORTAL MASTER PASSWORD -----
      const [masterPasswordHash, setMasterPasswordHash] = useState(() => localStorage.getItem('sg_master_hash') || null);
      const [hiddenPortalAuth, setHiddenPortalAuth] = useState(false);

      // ----- DERIVED DATA -----
      const [peopleData, setPeopleData] = useState({});

      // ----- UI STATE -----
      const [activeView, setActiveView] = useState('people');
      const [activeAlbum, setActiveAlbum] = useState(null);
      const [galleryContext, setGalleryContext] = useState(null);
      const [currentGallery, setCurrentGallery] = useState([]);
      const [currentPhotoIndex, setCurrentPhotoIndex] = useState(0);
      const [lightboxOpen, setLightboxOpen] = useState(false);
      const [slideshowInterval, setSlideshowInterval] = useState(null);
      const [greeting, setGreeting] = useState('');

      // ----- ZOOM STATE for lightbox -----
      const [zoomScale, setZoomScale] = useState(1);
      const [zoomTranslate, setZoomTranslate] = useState({ x: 0, y: 0 });

      // ----- MODAL STATES -----
      const [uploadModalOpen, setUploadModalOpen] = useState(false);
      const [hideModalOpen, setHideModalOpen] = useState(false);
      const [albumToHide, setAlbumToHide] = useState(null);
      const [backupCodesModalOpen, setBackupCodesModalOpen] = useState(false);
      const [currentBackupCodes, setCurrentBackupCodes] = useState([]);
      const [unlockModalOpen, setUnlockModalOpen] = useState(false);
      const [albumToUnlock, setAlbumToUnlock] = useState(null);
      const [unlockPortalModalOpen, setUnlockPortalModalOpen] = useState(false);
      const [changeMasterPwModalOpen, setChangeMasterPwModalOpen] = useState(false);
      const [toast, setToast] = useState({ show: false, msg: '', type: 'success' });

      // ----- UNLOCKED HIDDEN ALBUMS (session) -----
      const [unlockedHidden, setUnlockedHidden] = useState(new Set());

      // ---------- EFFECTS ----------
      useEffect(() => {
        async function loadData() {
          try {
            const [fileRes, thumbRes] = await Promise.all([
              fetch('data.json').catch(() => ({ json: () => [] })),
              fetch('thumbnails.json').catch(() => ({ json: () => ({}) }))
            ]);
            const fileList = await fileRes.json();
            const thumbMap = await thumbRes.json();
            setRawFileList([...new Set(fileList)]);
            setThumbnailMap(thumbMap);
          } catch (err) {
            console.warn('Using empty JSON fallback');
            setRawFileList([]);
            setThumbnailMap({});
          }
        }
        loadData();
      }, []);

      useEffect(() => {
        async function loadUploaded() {
          try {
            const images = await getAllFromStore(STORE_IMAGES);
            setUploadedImages(images || []);
            const thumbs = await getAllFromStore(STORE_THUMBS);
            const thumbObj = {};
            thumbs.forEach(t => thumbObj[t.album] = t.dataURL);
            setUploadedThumbnails(thumbObj);
          } catch (err) {
            console.warn('IndexedDB read failed', err);
            setUploadedImages([]);
            setUploadedThumbnails({});
          }
        }
        loadUploaded();
      }, []);

      useEffect(() => {
        uploadedImages.forEach(img => putItemInStore(STORE_IMAGES, img).catch(console.warn));
      }, [uploadedImages]);

      useEffect(() => {
        Object.entries(uploadedThumbnails).forEach(([album, dataURL]) => 
          putItemInStore(STORE_THUMBS, { album, dataURL }).catch(console.warn)
        );
      }, [uploadedThumbnails]);

      useEffect(() => {
        localStorage.setItem('sg_favorites', JSON.stringify([...favorites]));
      }, [favorites]);
      useEffect(() => {
        localStorage.setItem('sg_deleted_images', JSON.stringify(deletedImages));
      }, [deletedImages]);
      useEffect(() => {
        localStorage.setItem('sg_hidden_albums', JSON.stringify(hiddenAlbums));
      }, [hiddenAlbums]);
      useEffect(() => {
        localStorage.setItem('sg_view_settings', JSON.stringify(viewSettings));
      }, [viewSettings]);
      useEffect(() => { 
        if (masterPasswordHash) localStorage.setItem('sg_master_hash', masterPasswordHash);
        else localStorage.removeItem('sg_master_hash');
      }, [masterPasswordHash]);

      const effectiveThumbnailMap = useMemo(() => ({ ...thumbnailMap, ...uploadedThumbnails }), [thumbnailMap, uploadedThumbnails]);

      useEffect(() => {
        const allFiles = [...rawFileList];
        const activeUploaded = uploadedImages.filter(img => 
          !deletedImages.some(d => d.filename === img.filename)
        );
        activeUploaded.forEach(img => { if (!allFiles.includes(img.filename)) allFiles.push(img.filename); });
        const pd = {};
        allFiles.forEach(filename => {
          const cleanFile = filename.trim();
          if (!cleanFile) return;
          let namePart = cleanFile.includes('-') ? cleanFile.split('-')[0] : cleanFile.split('_')[0] || '';
          if (!namePart) return;
          let people = namePart.split('+');
          people.forEach(rawName => {
            let cleanName = rawName.trim();
            if (cleanName.length) {
              cleanName = cleanName.charAt(0).toUpperCase() + cleanName.slice(1);
              if (cleanName.toLowerCase() === 'idk') cleanName = 'IDK';
            }
            if (['Img', 'Picsart'].includes(cleanName)) return;
            if (!pd[cleanName]) pd[cleanName] = { count: 0, photos: [] };
            pd[cleanName].count++;
            pd[cleanName].photos.push(filename);
          });
        });
        setPeopleData(pd);
      }, [rawFileList, uploadedImages, deletedImages]);

      // ---------- HELPER FUNCTIONS ----------
      const showToast = (msg, type = 'success') => {
        setToast({ show: true, msg, type });
        setTimeout(() => setToast({ show: false, msg: '', type: 'success' }), 3000);
      };

      const getThumbUrl = (name) => {
        if (uploadedThumbnails[name]) return uploadedThumbnails[name];
        let thumbSrc = `${PATH_TO_THUMBS}${name}.jpg`;
        if (thumbnailMap[name]) thumbSrc = `${PATH_TO_THUMBS}${thumbnailMap[name]}`;
        return thumbSrc;
      };

      const getAllVisiblePhotos = useCallback(() => {
        const all = [];
        rawFileList.forEach(f => all.push(f));
        uploadedImages.forEach(img => {
          if (!deletedImages.some(d => d.filename === img.filename) && !all.includes(img.filename)) {
            all.push(img.filename);
          }
        });
        return all;
      }, [rawFileList, uploadedImages, deletedImages]);

      const isAlbumHidden = (name) => !!hiddenAlbums[name];
      const getAlbumPhotoCount = (albumName) => {
        let count = 0;
        rawFileList.forEach(f => {
          if (f.startsWith(albumName + '-') || f.startsWith(albumName + '_')) count++;
        });
        uploadedImages.forEach(img => {
          if (img.album === albumName && !deletedImages.some(d => d.filename === img.filename)) count++;
        });
        return count;
      };

      // ---------- FAVORITES ----------
      const toggleFavorite = (filename) => {
        setFavorites(prev => {
          const newSet = new Set(prev);
          if (newSet.has(filename)) newSet.delete(filename);
          else newSet.add(filename);
          return newSet;
        });
      };

      const openFavoriteLightbox = (filename) => {
        const favs = getAllVisiblePhotos().filter(f => favorites.has(f));
        if (favs.length === 0) return;
        const index = favs.indexOf(filename);
        if (index === -1) return;
        setActiveAlbum('Favorites');
        setGalleryContext('favorites');
        setCurrentGallery(favs);
        setActiveView('gallery');
        setTimeout(() => {
          setCurrentPhotoIndex(index);
          setLightboxOpen(true);
        }, 10);
      };

      // ---------- TRASH ----------
      const deleteUploadedImage = (filename) => {
        const img = uploadedImages.find(i => i.filename === filename);
        if (!img) return;
        setUploadedImages(prev => prev.filter(i => i.filename !== filename));
        setDeletedImages(prev => [...prev, { ...img, deletedAt: new Date().toISOString() }]);
        setFavorites(prev => { const s = new Set(prev); s.delete(filename); return s; });
        showToast('Moved to trash');
        if (currentGallery.includes(filename)) {
          setCurrentGallery(prev => prev.filter(f => f !== filename));
        }
        if (lightboxOpen && currentGallery[currentPhotoIndex] === filename) closeLightbox();
      };

      const restoreUploadedImage = (filename) => {
        const img = deletedImages.find(i => i.filename === filename);
        if (!img) return;
        setDeletedImages(prev => prev.filter(i => i.filename !== filename));
        setUploadedImages(prev => [...prev, img]);
        showToast('Image restored');
      };

      const permanentlyDeleteUploadedImage = (filename) => {
        setDeletedImages(prev => prev.filter(i => i.filename !== filename));
        removeItemFromStore(STORE_IMAGES, filename).catch(console.warn);
        showToast('Permanently deleted');
      };

      const clearTrash = () => {
        if (confirm('Permanently delete all items in trash?')) {
          deletedImages.forEach(img => removeItemFromStore(STORE_IMAGES, img.filename).catch(console.warn));
          setDeletedImages([]);
          showToast('Trash emptied');
          if (activeAlbum === 'Trash') setCurrentGallery([]);
        }
      };

      // ---------- LIGHTBOX DELETE ----------
      const deleteCurrentImage = () => {
        if (currentGallery.length && currentPhotoIndex >= 0) {
          const filename = currentGallery[currentPhotoIndex];
          const uploadedImg = uploadedImages.find(i => i.filename === filename);
          if (uploadedImg && activeAlbum !== 'Trash') {
            deleteUploadedImage(filename);
          }
        }
      };

      // ---------- HIDDEN ALBUMS & BACKUP CODES ----------
      const generateBackupCodes = () => {
        const codes = [];
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
        for (let i = 0; i < 5; i++) {
          let code = '';
          for (let j = 0; j < 8; j++) code += chars[Math.floor(Math.random() * chars.length)];
          codes.push({ code, used: false });
        }
        return codes;
      };

      const hideAlbum = async (albumName, password, question, answer) => {
        if (isAlbumHidden(albumName)) return false;
        const hashedPassword = await hashString(password);
        const hashedAnswer = await hashString(answer.toLowerCase());
        const codes = generateBackupCodes();
        setHiddenAlbums(prev => ({
          ...prev,
          [albumName]: {
            password: hashedPassword,
            question,
            answer: hashedAnswer,
            backupCodes: codes,
            hiddenAt: new Date().toISOString()
          }
        }));
        return codes;
      };

      const unhideAlbum = (albumName) => {
        setHiddenAlbums(prev => {
          const newObj = { ...prev };
          delete newObj[albumName];
          return newObj;
        });
        setUnlockedHidden(prev => {
          const s = new Set(prev);
          s.delete(albumName);
          return s;
        });
        showToast(`Album "${albumName}" is now visible`);
      };

      const useBackupCode = (albumName, code) => {
        const album = hiddenAlbums[albumName];
        if (!album) return false;
        const codeObj = album.backupCodes.find(c => c.code === code && !c.used);
        if (codeObj) {
          codeObj.used = true;
          setHiddenAlbums(prev => ({ ...prev, [albumName]: { ...album, backupCodes: [...album.backupCodes] } }));
          return true;
        }
        return false;
      };

      const regenerateBackupCodes = (albumName) => {
        const album = hiddenAlbums[albumName];
        if (!album) return null;
        const newCodes = generateBackupCodes();
        album.backupCodes = newCodes;
        setHiddenAlbums(prev => ({ ...prev, [albumName]: { ...album } }));
        return newCodes;
      };

      const promptUnlockAlbum = (albumName) => {
        setAlbumToUnlock(albumName);
        setUnlockModalOpen(true);
      };

      // ---------- MASTER PASSWORD FOR HIDDEN PORTAL (secure change) ----------
      const setMasterPassword = async (password) => {
        const hash = await hashString(password);
        setMasterPasswordHash(hash);
        setHiddenPortalAuth(true);
        setActiveView('hiddenPortal');
      };

      const verifyMasterPassword = async (password) => {
        if (!masterPasswordHash) return false;
        const hash = await hashString(password);
        return hash === masterPasswordHash;
      };

      const changeMasterPassword = async (oldPassword, newPassword) => {
        if (!masterPasswordHash) return false;
        const valid = await verifyMasterPassword(oldPassword);
        if (!valid) return false;
        await setMasterPassword(newPassword);
        return true;
      };

      // ---------- GALLERY NAVIGATION ----------
      const openGallery = (albumName, photos, context) => {
        setActiveAlbum(albumName);
        setGalleryContext(context);
        setCurrentGallery(photos);
        setActiveView('gallery');
        setZoomScale(1);
        setZoomTranslate({ x: 0, y: 0 });
      };

      const showAlbum = (name) => {
        if (name === 'Trash') {
          openGallery('Trash', deletedImages.map(i => i.filename), 'trash');
        } else if (name === 'Recent Uploads') {
          const sevenDaysAgo = Date.now() - 7*24*60*60*1000;
          const recent = uploadedImages.filter(img => new Date(img.date).getTime() > sevenDaysAgo);
          openGallery('Recent Uploads', recent.map(img => img.filename), 'recent');
        } else if (name === 'Favorites') {
          const favs = getAllVisiblePhotos().filter(f => favorites.has(f));
          openGallery('Favorites', favs, 'favorites');
        } else if (name === 'All Photos') {
          openGallery('All Photos', getAllVisiblePhotos(), 'all');
        } else {
          const data = peopleData[name];
          if (data) {
            openGallery(name, data.photos, 'album');
          }
        }
      };

      const handleAlbumClick = (name) => {
        if (isAlbumHidden(name)) {
          promptUnlockAlbum(name);
        } else {
          showAlbum(name);
        }
      };

      // ---------- LIGHTBOX ----------
      const openLightbox = (index) => { 
        setCurrentPhotoIndex(index); 
        setLightboxOpen(true);
        setZoomScale(1);
        setZoomTranslate({ x: 0, y: 0 });
      };
      const closeLightbox = () => { 
        setLightboxOpen(false); 
        if (slideshowInterval) { 
          clearInterval(slideshowInterval); 
          setSlideshowInterval(null); 
        }
        setZoomScale(1);
        setZoomTranslate({ x: 0, y: 0 });
      };
      const nextImage = () => {
        setCurrentPhotoIndex(prev => (prev + 1) % currentGallery.length);
        setZoomScale(1);
        setZoomTranslate({ x: 0, y: 0 });
      };
      const prevImage = () => {
        setCurrentPhotoIndex(prev => (prev - 1 + currentGallery.length) % currentGallery.length);
        setZoomScale(1);
        setZoomTranslate({ x: 0, y: 0 });
      };
      const toggleSlideshow = () => {
        if (slideshowInterval) { 
          clearInterval(slideshowInterval); 
          setSlideshowInterval(null); 
        } else { 
          nextImage(); 
          const int = setInterval(() => {
            setCurrentPhotoIndex(prev => (prev + 1) % currentGallery.length);
            setZoomScale(1);
            setZoomTranslate({ x: 0, y: 0 });
          }, 3000); 
          setSlideshowInterval(int); 
        }
      };

      const handleZoomIn = () => setZoomScale(prev => Math.min(prev + 0.5, 3));
      const handleZoomOut = () => setZoomScale(prev => Math.max(prev - 0.5, 1));
      const handleZoomReset = () => { setZoomScale(1); setZoomTranslate({ x: 0, y: 0 }); };

      // ---------- UPLOADS (multi-image) ----------
      const handleImageUpload = async (album, files) => {
        for (const file of files) {
          const dataURL = await readFileAsDataURL(file);
          const timestamp = Date.now();
          const random = Math.floor(Math.random() * 1000);
          const ext = file.name.split('.').pop() || 'jpg';
          const filename = `${album}-${timestamp}-${random}.${ext}`;
          const newImage = { filename, dataURL, album, date: new Date().toISOString() };
          setUploadedImages(prev => [...prev, newImage]);
        }
        showToast(`${files.length} image(s) added to "${album}"`);
      };
      const handleThumbnailUpload = async (album, file) => {
        const dataURL = await readFileAsDataURL(file);
        setUploadedThumbnails(prev => ({ ...prev, [album]: dataURL }));
        showToast(`Thumbnail for "${album}" updated`);
      };
      const readFileAsDataURL = (file) => new Promise((resolve, reject) => { const reader = new FileReader(); reader.onload = () => resolve(reader.result); reader.onerror = reject; reader.readAsDataURL(file); });

      const updateViewSetting = (key, value) => setViewSettings(prev => ({ ...prev, [key]: value }));

      const albumSuggestions = useMemo(() => {
        const albums = new Set([...Object.keys(peopleData), ...Object.keys(uploadedThumbnails)]);
        return Array.from(albums).sort();
      }, [peopleData, uploadedThumbnails]);

      // ---------- CONTEXT ----------
      const contextValue = {
        peopleData, thumbnailMap: effectiveThumbnailMap, uploadedImages, uploadedThumbnails,
        favorites, deletedImages, hiddenAlbums, viewSettings, albumSortOrder,
        activeView, activeAlbum, galleryContext, currentGallery, currentPhotoIndex,
        lightboxOpen, slideshowInterval, greeting, unlockedHidden, albumSuggestions,
        setUnlockedHidden, getAllVisiblePhotos, getThumbUrl, isAlbumHidden, getAlbumPhotoCount,
        toggleFavorite, deleteUploadedImage, restoreUploadedImage, permanentlyDeleteUploadedImage,
        clearTrash, hideAlbum, unhideAlbum, useBackupCode, regenerateBackupCodes,
        showAlbum, handleAlbumClick, openLightbox, closeLightbox, nextImage, prevImage,
        toggleSlideshow, deleteCurrentImage, openFavoriteLightbox,
        setAlbumSortOrder, updateViewSetting, handleImageUpload, handleThumbnailUpload,
        setActiveView, setActiveAlbum, setCurrentGallery, setGalleryContext, showToast,
        setUploadModalOpen, setHideModalOpen, setAlbumToHide, setBackupCodesModalOpen,
        setCurrentBackupCodes, setUnlockModalOpen, setAlbumToUnlock, promptUnlockAlbum,
        masterPasswordHash, hiddenPortalAuth, setHiddenPortalAuth, setMasterPassword, 
        verifyMasterPassword, changeMasterPassword, setUnlockPortalModalOpen,
        setChangeMasterPwModalOpen,
        zoomScale, zoomTranslate, setZoomScale, setZoomTranslate, handleZoomIn, handleZoomOut, handleZoomReset,
      };

      return (
        <AppContext.Provider value={contextValue}>
          <div className="flex flex-col min-h-screen">
            <Navbar />
            <div className="h-24"></div>
            <main className="container mx-auto px-4 sm:px-6 flex-grow relative">
              {activeView === 'people' && <PeopleView />}
              {activeView === 'gallery' && <GalleryView />}
              {activeView === 'hiddenPortal' && <HiddenPortalView />}
            </main>
            <Footer />
          </div>

          <UploadModal isOpen={uploadModalOpen} onClose={() => setUploadModalOpen(false)} onImageUpload={handleImageUpload} onThumbnailUpload={handleThumbnailUpload} albumSuggestions={albumSuggestions} />
          <HideAlbumModal isOpen={hideModalOpen} onClose={() => setHideModalOpen(false)} albumName={albumToHide} />
          <BackupCodesModal isOpen={backupCodesModalOpen} onClose={() => setBackupCodesModalOpen(false)} codes={currentBackupCodes} />
          <UnlockAlbumModal isOpen={unlockModalOpen} onClose={() => setUnlockModalOpen(false)} albumName={albumToUnlock} />
          <UnlockHiddenPortalModal isOpen={unlockPortalModalOpen} onClose={() => setUnlockPortalModalOpen(false)} />
          <ChangeMasterPasswordModal isOpen={changeMasterPwModalOpen} onClose={() => setChangeMasterPwModalOpen(false)} />
          <Lightbox />
          <Toast {...toast} />
        </AppContext.Provider>
      );
    }

    // ---------- COMPONENTS ----------
    const Navbar = () => {
      const { setActiveView, setUploadModalOpen, setAlbumSortOrder, albumSortOrder, showToast, hiddenPortalAuth, setUnlockPortalModalOpen } = useContext(AppContext);
      const [theme, setTheme] = useState(() => localStorage.theme || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'));

      useEffect(() => {
        if (theme === 'dark') { document.documentElement.classList.add('dark'); localStorage.theme = 'dark'; }
        else { document.documentElement.classList.remove('dark'); localStorage.theme = 'light'; }
      }, [theme]);

      const toggleTheme = () => setTheme(prev => prev === 'dark' ? 'light' : 'dark');
      const toggleSort = () => { setAlbumSortOrder(prev => prev === 'asc' ? 'desc' : 'asc'); showToast(`Sorted ${albumSortOrder === 'asc' ? 'Zâ†’A' : 'Aâ†’Z'}`); };

      const handleLockClick = () => {
        if (hiddenPortalAuth) {
          setActiveView('hiddenPortal');
        } else {
          setUnlockPortalModalOpen(true);
        }
      };

      return (
        <nav className="fixed top-0 w-full z-50 glass-nav transition-all duration-300">
          <div className="container mx-auto px-4 h-16 flex justify-between items-center">
            <div className="flex items-center gap-2 sm:gap-3 group cursor-pointer" onClick={() => window.location.reload()}>
              <div className="w-9 h-9 bg-gradient-to-br from-blue-600 to-blue-500 rounded-xl flex items-center justify-center text-white shadow-lg group-hover:scale-105 transition-transform">
                <i className="fa-solid fa-bolt"></i>
              </div>
              <h1 className="text-lg font-bold tracking-tight">Smart<span className="text-blue-600">Gallery</span></h1>
            </div>
            <div className="flex items-center gap-2 sm:gap-3 flex-grow justify-end">
              <button onClick={handleLockClick} className="w-9 h-9 rounded-full bg-white/50 dark:bg-slate-800/50 hover:bg-purple-50 dark:hover:bg-slate-800 text-purple-600 dark:text-purple-400 transition flex-shrink-0 backdrop-blur-sm">
                <i className="fa-solid fa-lock text-sm"></i>
              </button>
              <button onClick={toggleSort} className="w-9 h-9 rounded-full bg-white/50 dark:bg-slate-800/50 hover:bg-slate-50 dark:hover:bg-slate-800 text-slate-600 dark:text-slate-300 transition flex-shrink-0 backdrop-blur-sm">
                <i className={`fa-solid ${albumSortOrder === 'asc' ? 'fa-arrow-down-a-z' : 'fa-arrow-up-z-a'} text-sm`}></i>
              </button>
              <button onClick={() => setUploadModalOpen(true)} className="w-9 h-9 rounded-full bg-white/50 dark:bg-slate-800/50 hover:bg-blue-50 dark:hover:bg-slate-800 text-blue-600 dark:text-blue-400 transition flex-shrink-0 backdrop-blur-sm">
                <i className="fa-solid fa-cloud-upload-alt text-sm"></i>
              </button>
              <button onClick={toggleTheme} className="w-9 h-9 rounded-full bg-white/50 dark:bg-slate-800/50 hover:bg-yellow-50 dark:hover:bg-slate-800 text-slate-600 dark:text-yellow-400 transition flex-shrink-0 backdrop-blur-sm">
                <i className={`fa-solid ${theme === 'dark' ? 'fa-sun' : 'fa-moon'} text-sm`}></i>
              </button>
            </div>
          </div>
        </nav>
      );
    };

    const PeopleView = () => {
      const { peopleData, getAllVisiblePhotos, favorites, deletedImages, uploadedImages, isAlbumHidden, albumSortOrder, greeting, handleAlbumClick, getThumbUrl, setHideModalOpen, setAlbumToHide, showAlbum } = useContext(AppContext);
      const [searchQuery, setSearchQuery] = useState('');
      const allVisible = getAllVisiblePhotos();

      let albumNames = Object.keys(peopleData).filter(name => !isAlbumHidden(name));
      if (searchQuery) albumNames = albumNames.filter(n => n.toLowerCase().includes(searchQuery.toLowerCase()));
      albumNames.sort((a,b) => albumSortOrder === 'asc' ? a.localeCompare(b) : b.localeCompare(a));

      const favCount = [...favorites].filter(f => allVisible.includes(f)).length;
      const recentCount = uploadedImages.filter(img => new Date(img.date).getTime() > Date.now() - 7*24*60*60*1000).length;

      return (
        <div className="animate-enter pb-12">
          <FavoritesZone />

          <div className="mb-8 flex flex-col sm:flex-row sm:items-end justify-between gap-4">
            <div>
              <h2 className="text-3xl sm:text-4xl font-extrabold tracking-tight text-slate-900 dark:text-white">{greeting}</h2>
              <p className="text-slate-500 dark:text-slate-400 mt-1 text-sm font-medium">Your memories, beautifully organized.</p>
            </div>
            <div className="flex items-center gap-3">
              <div className="relative">
                <i className="fa-solid fa-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-xs sm:text-sm"></i>
                <input type="text" placeholder="Filter albums..." value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)}
                  className="bg-white/70 dark:bg-slate-800/70 border border-slate-200 dark:border-slate-700 focus:border-blue-500 rounded-full py-2 pl-9 pr-4 text-xs sm:text-sm w-48 sm:w-64 focus:ring-4 focus:ring-blue-500/10 outline-none transition-all backdrop-blur-sm"
                />
              </div>
              <div className="text-xs font-bold text-blue-600 bg-blue-50 dark:bg-blue-900/30 px-3 py-1.5 rounded-full">
                {Object.keys(peopleData).length} People
              </div>
            </div>
          </div>

          <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4 sm:gap-6">
            <AlbumCard name="All Photos" count={allVisible.length} icon="layer-group" gradient="from-blue-500 to-cyan-500" onClick={() => handleAlbumClick('All Photos')} />
            <AlbumCard name="Favorites" count={favCount} icon="heart" gradient="from-pink-500 to-rose-600" onClick={() => handleAlbumClick('Favorites')} />
            {recentCount > 0 && <AlbumCard name="Recent Uploads" count={recentCount} icon="clock" gradient="from-green-500 to-teal-500" onClick={() => handleAlbumClick('Recent Uploads')} />}
            {deletedImages.length > 0 && <AlbumCard name="Trash" count={deletedImages.length} icon="trash" gradient="from-amber-600 to-orange-600" onClick={() => handleAlbumClick('Trash')} />}
            
            {albumNames.map(name => {
              const data = peopleData[name];
              return (
                <div key={name} className="group relative overflow-hidden rounded-2xl aspect-[4/5] cursor-pointer shadow-sm hover:shadow-xl transition-all duration-500 hover:-translate-y-1 bg-slate-200 dark:bg-slate-800" onClick={() => handleAlbumClick(name)}>
                  <img src={getThumbUrl(name)} alt={name} loading="lazy" className="absolute inset-0 w-full h-full object-cover transition duration-700 group-hover:scale-110 img-loading" onLoad={(e) => e.target.classList.add('img-loaded')} onError={(e) => e.target.src = `https://ui-avatars.com/api/?name=${name}&background=random`} />
                  <div className="absolute inset-0 bg-gradient-to-t from-black/80 via-black/20 to-transparent opacity-80 group-hover:opacity-90 transition-opacity"></div>
                  <div className="absolute bottom-0 left-0 p-4 w-full translate-y-1 group-hover:translate-y-0 transition-transform duration-300">
                    <h3 className="text-white text-lg font-bold tracking-wide truncate leading-tight">{name}</h3>
                    <span className="inline-block px-2 py-0.5 bg-white/20 backdrop-blur-sm rounded-full text-[9px] font-medium text-white border border-white/10">{data.count} Photos</span>
                  </div>
                  <button onClick={(e) => { e.stopPropagation(); setAlbumToHide(name); setHideModalOpen(true); }} className="absolute top-2 right-2 w-8 h-8 rounded-full bg-black/50 backdrop-blur-sm flex items-center justify-center text-white opacity-0 group-hover:opacity-100 transition-opacity hover:bg-purple-600 z-10">
                    <i className="fa-solid fa-lock text-xs"></i>
                  </button>
                </div>
              );
            })}
          </div>
          {albumNames.length === 0 && !searchQuery && Object.keys(peopleData).length === 0 && (
            <div className="text-center py-20"><p className="text-slate-500 dark:text-slate-400">No albums yet. Upload some images!</p></div>
          )}
        </div>
      );
    };

    const AlbumCard = ({ name, count, icon, gradient, onClick }) => (
      <div className={`group relative overflow-hidden rounded-2xl aspect-[4/5] cursor-pointer shadow-md hover:shadow-xl transition-all duration-500 hover:-translate-y-1 bg-gradient-to-br ${gradient}`} onClick={onClick}>
        <div className="absolute inset-0 flex items-center justify-center text-white/90 group-hover:scale-110 transition-transform duration-700">
          <i className={`fa-solid fa-${icon} text-6xl drop-shadow-lg`}></i>
        </div>
        <div className="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent"></div>
        <div className="absolute bottom-0 left-0 p-4 w-full">
          <h3 className="text-white text-lg font-bold tracking-wide">{name}</h3>
          <p className="text-white/80 text-xs font-medium">{count} Photos</p>
        </div>
      </div>
    );

    const FavoritesZone = () => {
      const { favorites, openFavoriteLightbox, getAllVisiblePhotos, uploadedImages, showAlbum } = useContext(AppContext);
      const favArray = [...favorites].filter(f => getAllVisiblePhotos().includes(f));
      if (favArray.length === 0) return null;
      const displayFavs = favArray.sort(() => 0.5 - Math.random()).slice(0, 12);
      return (
        <div className="mb-12">
          <div className="flex items-center justify-between mb-4">
            <h2 className="text-xl sm:text-2xl font-extrabold tracking-tight flex items-center gap-2">
              <i className="fa-solid fa-heart text-rose-500"></i><span>Favorites Zone</span>
            </h2>
            <button onClick={() => showAlbum('Favorites')} className="text-xs font-bold text-blue-600 hover:text-blue-700 dark:text-blue-400 px-3 py-1.5 rounded-full bg-blue-50 dark:bg-blue-900/30 transition">
              View All
            </button>
          </div>
          <div className="favorites-zone pb-2">
            {displayFavs.map(file => {
              const uploaded = uploadedImages.find(img => img.filename === file);
              const src = uploaded ? uploaded.dataURL : `${PATH_TO_IMAGES}${file}`;
              const isVideo = file.toLowerCase().endsWith('.mp4');
              return (
                <div key={file} className="fav-item cursor-pointer" onClick={() => openFavoriteLightbox(file)}>
                  <div className="relative aspect-square rounded-xl overflow-hidden shadow-md hover:shadow-xl transition-all duration-300 hover:scale-[1.02] bg-slate-200 dark:bg-slate-800">
                    {isVideo ? <video src={src} className="w-full h-full object-cover" /> : <img src={src} loading="lazy" className="w-full h-full object-cover img-loading" onLoad={(e) => e.target.classList.add('img-loaded')} />}
                  </div>
                </div>
              );
            })}
          </div>
        </div>
      );
    };

    const GalleryView = () => {
      const { activeAlbum, galleryContext, currentGallery, viewSettings, updateViewSetting, uploadedImages, deletedImages, favorites, toggleFavorite, deleteUploadedImage, restoreUploadedImage, permanentlyDeleteUploadedImage, clearTrash, getThumbUrl, openLightbox, setActiveView } = useContext(AppContext);
      const [dropdownOpen, setDropdownOpen] = useState(false);
      const isTrash = galleryContext === 'trash';
      const avatarSrc = !isTrash && activeAlbum !== 'Favorites' && activeAlbum !== 'All Photos' && activeAlbum !== 'Recent Uploads' ? getThumbUrl(activeAlbum) : null;

      const trashImages = isTrash ? deletedImages : [];

      const getPhotoSrc = (filename) => {
        const uploaded = uploadedImages.find(img => img.filename === filename);
        if (uploaded) return uploaded.dataURL;
        const deleted = deletedImages.find(img => img.filename === filename);
        if (deleted) return deleted.dataURL;
        return `${PATH_TO_IMAGES}${filename}`;
      };

      return (
        <div className="animate-enter pb-12">
          <div className="sticky top-20 z-30 -mx-4 px-4 sm:mx-0 sm:px-0 mb-8">
            <div className="bg-white/80 dark:bg-slate-900/80 backdrop-blur-xl border border-slate-200/50 dark:border-slate-800/50 shadow-lg rounded-2xl p-3 sm:p-4 flex items-center justify-between">
              <div className="flex items-center gap-4">
                <button onClick={() => setActiveView('people')} className="w-10 h-10 flex items-center justify-center rounded-full bg-slate-100 dark:bg-slate-800 hover:bg-slate-900 hover:text-white dark:hover:bg-white dark:hover:text-slate-900 transition-all shadow-sm">
                  <i className="fa-solid fa-arrow-left text-sm"></i>
                </button>
                <div className="flex items-center gap-3">
                  <div className={`w-10 h-10 rounded-full overflow-hidden shadow-md ring-2 ring-white dark:ring-slate-700 flex items-center justify-center ${isTrash ? 'bg-amber-100 dark:bg-amber-900/30' : activeAlbum === 'Favorites' ? 'bg-rose-100 dark:bg-rose-900/30' : activeAlbum === 'All Photos' ? 'bg-blue-100 dark:bg-blue-900/30' : activeAlbum === 'Recent Uploads' ? 'bg-green-100 dark:bg-green-900/30' : 'bg-slate-100 dark:bg-slate-800'}`}>
                    {avatarSrc ? <img src={avatarSrc} alt="" className="w-full h-full object-cover" /> : <i className={`fa-solid ${isTrash ? 'fa-trash text-amber-500' : activeAlbum === 'Favorites' ? 'fa-heart text-rose-500' : activeAlbum === 'All Photos' ? 'fa-layer-group text-blue-500' : activeAlbum === 'Recent Uploads' ? 'fa-clock text-green-500' : ''} text-lg`}></i>}
                  </div>
                  <div className="leading-tight">
                    <h2 className="text-lg font-bold text-slate-900 dark:text-white">{activeAlbum}</h2>
                    <p className="text-xs text-slate-500 dark:text-slate-400 font-medium">{isTrash ? trashImages.length : currentGallery.length} Photos</p>
                  </div>
                </div>
              </div>
              <div className="relative">
                <button onClick={() => setDropdownOpen(!dropdownOpen)} className="w-10 h-10 rounded-full bg-slate-100 dark:bg-slate-800 hover:bg-blue-50 dark:hover:bg-slate-700 text-slate-600 dark:text-slate-300 transition shadow-sm">
                  <i className="fa-solid fa-sliders"></i>
                </button>
                {dropdownOpen && (
                  <div className="absolute right-0 top-12 w-56 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl shadow-xl z-40 p-3 animate-enter">
                    <div className="space-y-4">
                      <div>
                        <p className="text-[10px] uppercase font-bold text-slate-400 mb-2">Grid Layout</p>
                        <div className="flex bg-slate-100 dark:bg-slate-800 p-1 rounded-lg">
                          {['masonry', 'square'].map(type => (
                            <button key={type} onClick={() => updateViewSetting('type', type)} className={`flex-1 py-1.5 rounded-md text-xs font-medium transition-colors ${viewSettings.type === type ? 'bg-white text-blue-600 shadow-sm dark:bg-slate-700 dark:text-blue-400' : 'text-slate-500'}`}>
                              {type === 'masonry' ? 'Masonry' : 'Square'}
                            </button>
                          ))}
                        </div>
                      </div>
                      <div>
                        <p className="text-[10px] uppercase font-bold text-slate-400 mb-2">Thumbnail Size</p>
                        <div className="flex justify-between items-center bg-slate-100 dark:bg-slate-800 p-1 rounded-lg px-2">
                          {['small', 'medium', 'large'].map((size, i) => (
                            <button key={size} onClick={() => updateViewSetting('size', size)} className={`w-8 h-8 rounded hover:bg-white dark:hover:bg-slate-700 transition flex items-center justify-center ${viewSettings.size === size ? 'bg-white text-blue-600 shadow-sm dark:bg-slate-700 dark:text-blue-400' : 'text-slate-500'}`}>
                              <i className={`fa-solid fa-border-all ${i === 0 ? 'text-xs' : i === 1 ? 'text-sm' : 'text-lg'}`}></i>
                            </button>
                          ))}
                        </div>
                      </div>
                      <div>
                        <div className="flex items-center justify-between cursor-pointer" onClick={() => updateViewSetting('showInfo', !viewSettings.showInfo)}>
                          <span className="text-xs font-medium text-slate-700 dark:text-slate-300">Show File Info</span>
                          <div className={`w-8 h-4 rounded-full relative transition-colors ${viewSettings.showInfo ? 'bg-blue-500' : 'bg-slate-200 dark:bg-slate-700'}`}>
                            <div className={`w-4 h-4 bg-white rounded-full shadow absolute left-0 transition-all transform ${viewSettings.showInfo ? 'translate-x-4' : 'translate-x-0'}`}></div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                )}
              </div>
            </div>
          </div>

          <div id="photo-container">
            {(isTrash ? trashImages.length === 0 : currentGallery.length === 0) ? (
              <div className="text-center py-32">
                <div className="w-20 h-20 bg-slate-50 dark:bg-slate-800/50 rounded-full flex items-center justify-center mx-auto mb-4 text-slate-300 dark:text-slate-600">
                  <i className="fa-regular fa-image text-3xl"></i>
                </div>
                <p className="text-slate-400 dark:text-slate-500 font-medium">It's looking a bit empty here.</p>
              </div>
            ) : (
              <>
                <div className={viewSettings.type === 'square' 
                  ? `grid ${viewSettings.size === 'small' ? 'grid-cols-3 sm:grid-cols-5 lg:grid-cols-7 gap-1' : viewSettings.size === 'large' ? 'grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4' : 'grid-cols-3 sm:grid-cols-4 lg:grid-cols-5 gap-1'}`
                  : `columns-2 sm:columns-3 lg:columns-4 ${viewSettings.size === 'small' ? 'gap-4' : viewSettings.size === 'large' ? 'gap-6' : 'gap-4'}`}>
                  {(isTrash ? trashImages : currentGallery).map((item, idx) => {
                    let filename, src, isVideo, inTrash = isTrash;
                    if (isTrash) {
                      filename = item.filename;
                      src = item.dataURL;
                      isVideo = filename.toLowerCase().endsWith('.mp4');
                    } else {
                      filename = item;
                      src = getPhotoSrc(filename);
                      isVideo = filename.toLowerCase().endsWith('.mp4');
                    }
                    return (
                      <div key={filename} className={viewSettings.type === 'square' 
                        ? `group relative aspect-square overflow-hidden cursor-zoom-in bg-slate-200 dark:bg-slate-800 ${viewSettings.size === 'small' ? '' : 'mb-4'}`
                        : `masonry-item break-inside-avoid group relative rounded-xl overflow-hidden cursor-zoom-in bg-slate-200 dark:bg-slate-800 shadow-sm hover:shadow-md transition-all mb-4`}
                        onClick={() => openLightbox(idx)}>
                        {isVideo ? <video src={src} className="w-full h-full object-cover pointer-events-none" /> : <img src={src} loading="lazy" className="w-full h-full object-cover transition duration-700 group-hover:scale-110 img-loading" onLoad={(e) => e.target.classList.add('img-loaded')} />}
                        
                        <div className="absolute top-2 right-2 flex gap-1 z-20">
                          {inTrash ? (
                            <>
                              <button onClick={(e) => { e.stopPropagation(); restoreUploadedImage(filename); }} className="w-7 h-7 rounded-full bg-emerald-600 hover:bg-emerald-700 text-white flex items-center justify-center shadow-lg photo-action-btn">
                                <i className="fa-solid fa-rotate-left text-xs"></i>
                              </button>
                              <button onClick={(e) => { e.stopPropagation(); permanentlyDeleteUploadedImage(filename); }} className="w-7 h-7 rounded-full bg-red-600 hover:bg-red-700 text-white flex items-center justify-center shadow-lg photo-action-btn">
                                <i className="fa-solid fa-trash text-xs"></i>
                              </button>
                            </>
                          ) : (
                            uploadedImages.some(i => i.filename === filename) && !inTrash && (
                              <button onClick={(e) => { e.stopPropagation(); deleteUploadedImage(filename); }} className="w-7 h-7 rounded-full bg-red-500 hover:bg-red-600 text-white flex items-center justify-center shadow-lg photo-action-btn">
                                <i className="fa-solid fa-trash text-xs"></i>
                              </button>
                            )
                          )}
                        </div>

                        {viewSettings.showInfo && !inTrash && (
                          <div className="absolute bottom-0 left-0 w-full p-2 bg-gradient-to-t from-black/80 to-transparent pointer-events-none">
                            <p className="text-white text-[10px] font-mono truncate opacity-90">{filename}</p>
                          </div>
                        )}
                      </div>
                    );
                  })}
                </div>
                {isTrash && deletedImages.length > 0 && (
                  <div className="flex justify-center mt-8">
                    <button onClick={clearTrash} className="px-6 py-3 bg-red-600 hover:bg-red-700 text-white rounded-full text-sm font-bold shadow-lg transition flex items-center gap-2">
                      <i className="fa-solid fa-trash"></i> Empty Trash
                    </button>
                  </div>
                )}
              </>
            )}
          </div>
        </div>
      );
    };

    const HiddenPortalView = () => {
      const { hiddenAlbums, unlockedHidden, showAlbum, getThumbUrl, getAlbumPhotoCount, unhideAlbum, regenerateBackupCodes, setBackupCodesModalOpen, setCurrentBackupCodes, setActiveView, promptUnlockAlbum, setHiddenPortalAuth, setChangeMasterPwModalOpen } = useContext(AppContext);
      const hiddenNames = Object.keys(hiddenAlbums);

      const handleLogout = () => {
        setHiddenPortalAuth(false);
        setActiveView('people');
      };

      return (
        <div className="animate-enter pb-12">
          <div className="sticky top-20 z-30 -mx-4 px-4 sm:mx-0 sm:px-0 mb-8">
            <div className="bg-white/80 dark:bg-slate-900/80 backdrop-blur-xl border border-slate-200/50 dark:border-slate-800/50 shadow-lg rounded-2xl p-3 sm:p-4 flex items-center justify-between">
              <div className="flex items-center gap-4">
                <button onClick={() => setActiveView('people')} className="w-10 h-10 flex items-center justify-center rounded-full bg-slate-100 dark:bg-slate-800 hover:bg-slate-900 hover:text-white dark:hover:bg-white dark:hover:text-slate-900 transition-all shadow-sm">
                  <i className="fa-solid fa-arrow-left text-sm"></i>
                </button>
                <h2 className="text-xl font-bold text-slate-900 dark:text-white flex items-center gap-2">
                  <i className="fa-solid fa-lock text-purple-500"></i> Hidden Vault
                </h2>
              </div>
              <div className="flex gap-2">
                <button onClick={() => setChangeMasterPwModalOpen(true)} className="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-xs rounded-full transition shadow-md">
                  <i className="fa-solid fa-key mr-1"></i> Change Password
                </button>
                <button onClick={handleLogout} className="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white text-xs rounded-full transition shadow-md">
                  <i className="fa-solid fa-sign-out-alt mr-1"></i> Lock Vault
                </button>
              </div>
            </div>
          </div>

          {hiddenNames.length === 0 ? (
            <div className="text-center py-20">
              <div className="w-20 h-20 bg-slate-100 dark:bg-slate-800 rounded-full flex items-center justify-center mx-auto mb-4 text-slate-400">
                <i className="fa-solid fa-lock text-3xl"></i>
              </div>
              <p className="text-slate-500 dark:text-slate-400 font-medium">No hidden albums.</p>
            </div>
          ) : (
            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-5">
              {hiddenNames.map(name => {
                const count = getAlbumPhotoCount(name);
                const isUnlocked = unlockedHidden.has(name);
                return (
                  <div key={name} className="group bg-white dark:bg-slate-800/90 rounded-2xl shadow-lg hover:shadow-xl transition-all duration-300 overflow-hidden border border-slate-200/70 dark:border-slate-700/70">
                    <div className="relative aspect-[4/3] bg-slate-200 dark:bg-slate-700 cursor-pointer" onClick={() => isUnlocked ? showAlbum(name) : promptUnlockAlbum(name)}>
                      <img src={getThumbUrl(name)} alt={name} className="absolute inset-0 w-full h-full object-cover img-loading" onLoad={(e) => e.target.classList.add('img-loaded')} onError={(e) => e.target.src = `https://ui-avatars.com/api/?name=${name}&background=6b21a8&color=fff`} />
                      <div className="absolute inset-0 bg-gradient-to-t from-black/70 via-transparent to-transparent"></div>
                      <div className="absolute bottom-2 left-3 right-3 flex justify-between items-end">
                        <h3 className="text-white font-bold text-lg truncate">{name}</h3>
                        <span className="bg-white/30 backdrop-blur-sm text-white text-xs px-2 py-1 rounded-full border border-white/20">
                          {count} photos
                        </span>
                      </div>
                      {!isUnlocked && (
                        <div className="absolute top-2 left-2 bg-black/60 backdrop-blur-sm text-white text-[10px] px-2 py-1 rounded-full border border-white/20">
                          <i className="fa-solid fa-lock mr-1"></i> Locked
                        </div>
                      )}
                    </div>
                    <div className="p-3 flex flex-wrap gap-2">
                      <button onClick={() => isUnlocked ? showAlbum(name) : promptUnlockAlbum(name)} 
                        className={`flex-1 py-1.5 text-xs rounded-full font-medium transition flex items-center justify-center gap-1 ${isUnlocked ? 'bg-blue-100 text-blue-700 dark:bg-blue-900/40 dark:text-blue-300' : 'bg-purple-100 text-purple-700 dark:bg-purple-900/40 dark:text-purple-300'}`}>
                        <i className={`fa-solid ${isUnlocked ? 'fa-eye' : 'fa-unlock-alt'}`}></i>
                        {isUnlocked ? 'View' : 'Unlock'}
                      </button>
                      <button onClick={() => unhideAlbum(name)} 
                        className="flex-1 py-1.5 text-xs rounded-full bg-amber-100 text-amber-700 hover:bg-amber-200 dark:bg-amber-900/40 dark:text-amber-300 transition font-medium flex items-center justify-center gap-1">
                        <i className="fa-solid fa-lock-open"></i> Unhide
                      </button>
                      <button onClick={() => { const newCodes = regenerateBackupCodes(name); setCurrentBackupCodes(newCodes); setBackupCodesModalOpen(true); }} 
                        className="w-8 h-6 rounded-full bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-200 transition flex items-center justify-center text-xs">
                        <i className="fa-solid fa-arrows-rotate"></i>
                      </button>
                    </div>
                  </div>
                );
              })}
            </div>
          )}
        </div>
      );
    };

    // âœ… FIXED: All hooks moved before any conditional return
    const UnlockHiddenPortalModal = ({ isOpen, onClose }) => {
      const { masterPasswordHash, setMasterPassword, verifyMasterPassword, setHiddenPortalAuth, setActiveView, showToast } = useContext(AppContext);
      const [password, setPassword] = useState('');
      const [error, setError] = useState('');

      if (!isOpen) return null;

      const handleSubmit = async () => {
        if (!masterPasswordHash) {
          if (!password) { setError('Password required'); return; }
          await setMasterPassword(password);
          showToast('Master password set. Hidden vault unlocked.');
          onClose();
        } else {
          const valid = await verifyMasterPassword(password);
          if (valid) {
            setHiddenPortalAuth(true);
            setActiveView('hiddenPortal');
            showToast('Hidden vault unlocked');
            onClose();
          } else {
            setError('Incorrect password');
          }
        }
      };

      return (
        <div className="fixed inset-0 z-[200] flex items-center justify-center p-4 bg-black/50 backdrop-blur-md" onClick={onClose}>
          <div className="glass-modal rounded-3xl shadow-2xl max-w-md w-full p-6 sm:p-8" onClick={e => e.stopPropagation()}>
            <h3 className="text-2xl font-bold text-slate-900 dark:text-white mb-4 flex items-center gap-3">
              <i className="fa-solid fa-shield text-purple-600"></i>
              <span>{!masterPasswordHash ? 'Create Master Password' : 'Enter Master Password'}</span>
            </h3>
            <p className="text-sm text-slate-600 dark:text-slate-400 mb-4">
              {!masterPasswordHash ? 'This password will be required to access the hidden vault.' : 'Access your secret gallery.'}
            </p>
            <div className="space-y-4">
              <div>
                <input type="password" placeholder="Password" value={password} onChange={(e) => { setPassword(e.target.value); setError(''); }} className="w-full px-4 py-3 rounded-xl bg-white/70 dark:bg-slate-900/70 border border-slate-200 dark:border-slate-700 focus:border-purple-500 focus:ring-4 focus:ring-purple-500/10 outline-none transition dark:text-white" />
              </div>
              {error && <p className="text-xs text-red-600 dark:text-red-400">{error}</p>}
            </div>
            <div className="flex gap-3 mt-6">
              <button onClick={handleSubmit} className="flex-1 py-3 bg-gradient-to-r from-purple-600 to-purple-500 hover:from-purple-500 hover:to-purple-400 text-white font-bold rounded-xl shadow-lg transition">
                {!masterPasswordHash ? 'Create & Unlock' : 'Unlock'}
              </button>
              <button onClick={onClose} className="flex-1 py-3 bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 rounded-xl font-medium transition">
                Cancel
              </button>
            </div>
          </div>
        </div>
      );
    };

    // âœ… FIXED: All hooks moved before any conditional return
    const ChangeMasterPasswordModal = ({ isOpen, onClose }) => {
      const { masterPasswordHash, changeMasterPassword, showToast } = useContext(AppContext);
      const [oldPassword, setOldPassword] = useState('');
      const [newPassword, setNewPassword] = useState('');
      const [confirm, setConfirm] = useState('');
      const [error, setError] = useState('');

      if (!isOpen) return null;

      const handleChange = async () => {
        if (!masterPasswordHash) {
          showToast('No master password set. Use unlock to create one.', 'error');
          onClose();
          return;
        }
        if (!oldPassword || !newPassword || !confirm) {
          setError('All fields required');
          return;
        }
        if (newPassword !== confirm) {
          setError('New passwords do not match');
          return;
        }
        const success = await changeMasterPassword(oldPassword, newPassword);
        if (success) {
          showToast('Master password changed successfully');
          onClose();
        } else {
          setError('Old password is incorrect');
        }
      };

      return (
        <div className="fixed inset-0 z-[210] flex items-center justify-center p-4 bg-black/50 backdrop-blur-md" onClick={onClose}>
          <div className="glass-modal rounded-3xl shadow-2xl max-w-md w-full p-6 sm:p-8" onClick={e => e.stopPropagation()}>
            <h3 className="text-2xl font-bold text-slate-900 dark:text-white mb-4 flex items-center gap-3">
              <i className="fa-solid fa-key text-blue-600"></i> Change Master Password
            </h3>
            <div className="space-y-4">
              <div>
                <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-2">Current Password</label>
                <input type="password" value={oldPassword} onChange={(e) => { setOldPassword(e.target.value); setError(''); }} className="w-full px-4 py-3 rounded-xl bg-white/70 dark:bg-slate-900/70 border border-slate-200 dark:border-slate-700 focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 outline-none transition dark:text-white" />
              </div>
              <div>
                <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-2">New Password</label>
                <input type="password" value={newPassword} onChange={(e) => setNewPassword(e.target.value)} className="w-full px-4 py-3 rounded-xl bg-white/70 dark:bg-slate-900/70 border border-slate-200 dark:border-slate-700 focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 outline-none transition dark:text-white" />
              </div>
              <div>
                <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-2">Confirm New Password</label>
                <input type="password" value={confirm} onChange={(e) => setConfirm(e.target.value)} className="w-full px-4 py-3 rounded-xl bg-white/70 dark:bg-slate-900/70 border border-slate-200 dark:border-slate-700 focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 outline-none transition dark:text-white" />
              </div>
              {error && <p className="text-xs text-red-600 dark:text-red-400">{error}</p>}
            </div>
            <div className="flex gap-3 mt-6">
              <button onClick={handleChange} className="flex-1 py-3 bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-500 hover:to-blue-400 text-white font-bold rounded-xl shadow-lg transition">
                Change Password
              </button>
              <button onClick={onClose} className="flex-1 py-3 bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 rounded-xl font-medium transition">
                Cancel
              </button>
            </div>
          </div>
        </div>
      );
    };

    // âœ… FIXED: All hooks moved before any conditional return
    const UploadModal = ({ isOpen, onClose, onImageUpload, onThumbnailUpload, albumSuggestions }) => {
      const [tab, setTab] = useState('thumbnail');
      const [album, setAlbum] = useState('');
      const [files, setFiles] = useState([]);
      const [thumbnailFile, setThumbnailFile] = useState(null);
      const [thumbnailName, setThumbnailName] = useState('');

      if (!isOpen) return null;

      const handleThumbnailFileChange = (e) => { 
        const f = e.target.files[0]; 
        if (f) { 
          setThumbnailFile(f); 
          setThumbnailName(f.name); 
        } 
      };
      const handleImageFilesChange = (e) => {
        const selected = Array.from(e.target.files);
        setFiles(selected);
      };

      const handleSubmit = async () => {
        if (!album.trim()) { alert('Please enter album name'); return; }
        if (tab === 'thumbnail') {
          if (!thumbnailFile) { alert('Select a thumbnail image'); return; }
          await onThumbnailUpload(album.trim(), thumbnailFile);
          onClose(); 
          setAlbum(''); setThumbnailFile(null); setThumbnailName(''); setFiles([]);
        } else {
          if (files.length === 0) { alert('Select at least one image'); return; }
          await onImageUpload(album.trim(), files);
          onClose(); 
          setAlbum(''); setFiles([]); setThumbnailFile(null);
        }
      };

      return (
        <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/40 backdrop-blur-sm" onClick={onClose}>
          <div className="glass-modal rounded-3xl shadow-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto p-6 sm:p-8" onClick={e => e.stopPropagation()}>
            <div className="flex justify-between items-center mb-6">
              <h3 className="text-2xl font-bold text-slate-900 dark:text-white flex items-center gap-3"><i className="fa-solid fa-cloud-upload-alt text-blue-500"></i><span>Upload Studio</span></h3>
              <button onClick={onClose} className="w-10 h-10 rounded-full bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 dark:hover:bg-slate-700"><i className="fa-solid fa-xmark text-lg"></i></button>
            </div>
            <div className="flex bg-slate-100/80 dark:bg-slate-800/80 rounded-full p-1 mb-8">
              <button onClick={() => setTab('thumbnail')} className={`upload-tab flex-1 py-2.5 px-4 rounded-full text-sm font-medium transition-all ${tab === 'thumbnail' ? 'bg-white text-blue-600 shadow-sm dark:bg-slate-700 dark:text-blue-400' : ''}`}>Add Thumbnail</button>
              <button onClick={() => setTab('image')} className={`upload-tab flex-1 py-2.5 px-4 rounded-full text-sm font-medium transition-all ${tab === 'image' ? 'bg-white text-blue-600 shadow-sm dark:bg-slate-700 dark:text-blue-400' : ''}`}>Upload Images</button>
            </div>
            <div className="space-y-5">
              <div>
                <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-2">Album Name</label>
                <input 
                  type="text" 
                  value={album} 
                  onChange={(e) => setAlbum(e.target.value)} 
                  placeholder="e.g. Maria, Trips, Family" 
                  list="album-suggestions"
                  className="w-full px-4 py-3 rounded-xl bg-white/70 dark:bg-slate-900/70 border border-slate-200 dark:border-slate-700 focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 outline-none transition dark:text-white" 
                />
                <datalist id="album-suggestions">
                  {albumSuggestions.map(name => <option key={name} value={name} />)}
                </datalist>
              </div>
              <div>
                <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-2">
                  {tab === 'thumbnail' ? 'Thumbnail Image' : 'Image Files'}
                </label>
                <div className="relative border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-xl p-6 text-center hover:border-blue-500 transition cursor-pointer">
                  <input 
                    type="file" 
                    accept="image/*" 
                    onChange={tab === 'thumbnail' ? handleThumbnailFileChange : handleImageFilesChange} 
                    multiple={tab === 'image'} 
                    className="absolute inset-0 w-full h-full opacity-0 cursor-pointer" 
                  />
                  <i className="fa-solid fa-cloud-upload-alt text-3xl text-slate-400 mb-2"></i>
                  <p className="text-sm text-slate-600 dark:text-slate-300">Click or drag {tab === 'thumbnail' ? 'image' : 'images'}</p>
                  {tab === 'thumbnail' && thumbnailName && <p className="text-xs text-blue-500 mt-1 truncate">{thumbnailName}</p>}
                  {tab === 'image' && files.length > 0 && <p className="text-xs text-blue-500 mt-1 truncate">{files.length} file(s) selected</p>}
                </div>
              </div>
              <button onClick={handleSubmit} className={`w-full py-3.5 bg-gradient-to-r ${tab === 'thumbnail' ? 'from-blue-600 to-blue-500' : 'from-emerald-600 to-emerald-500'} hover:from-blue-500 hover:to-blue-400 text-white font-bold rounded-xl shadow-lg shadow-blue-500/30 transition-all flex items-center justify-center gap-2`}>
                <i className={`fa-solid ${tab === 'thumbnail' ? 'fa-plus-circle' : 'fa-arrow-up-from-bracket'}`}></i>
                <span>{tab === 'thumbnail' ? 'Set as Thumbnail' : `Upload ${files.length} Image(s)`}</span>
              </button>
            </div>
          </div>
        </div>
      );
    };

    // âœ… FIXED: All hooks moved before any conditional return
    const HideAlbumModal = ({ isOpen, onClose, albumName }) => {
      const { hideAlbum, setBackupCodesModalOpen, setCurrentBackupCodes, showToast } = useContext(AppContext);
      const [password, setPassword] = useState('');
      const [confirm, setConfirm] = useState('');
      const [question, setQuestion] = useState('');
      const [answer, setAnswer] = useState('');

      if (!isOpen || !albumName) return null;

      const handleHide = async () => {
        if (!password || !confirm || !question || !answer) { showToast('All fields required', 'error'); return; }
        if (password !== confirm) { showToast('Passwords do not match', 'error'); return; }
        const codes = await hideAlbum(albumName, password, question, answer);
        if (codes) { onClose(); setCurrentBackupCodes(codes); setBackupCodesModalOpen(true); } 
        else { showToast('Album already hidden', 'error'); }
      };

      return (
        <div className="fixed inset-0 z-[110] flex items-center justify-center p-4 bg-black/40 backdrop-blur-sm" onClick={onClose}>
          <div className="glass-modal rounded-3xl shadow-2xl max-w-lg w-full p-6 sm:p-8" onClick={e => e.stopPropagation()}>
            <div className="flex justify-between items-center mb-6">
              <h3 className="text-2xl font-bold text-slate-900 dark:text-white flex items-center gap-3"><i className="fa-solid fa-lock text-purple-500"></i><span>Hide Album</span></h3>
              <button onClick={onClose} className="w-10 h-10 rounded-full bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 dark:hover:bg-slate-700"><i className="fa-solid fa-xmark text-lg"></i></button>
            </div>
            <div className="mb-4 text-lg font-semibold text-blue-600 dark:text-blue-400">{albumName}</div>
            <div className="space-y-4">
              <div><label className="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-2">Password</label><input type="password" value={password} onChange={(e) => setPassword(e.target.value)} className="w-full px-4 py-3 rounded-xl bg-white/70 dark:bg-slate-900/70 border border-slate-200 dark:border-slate-700 focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 outline-none transition dark:text-white" /></div>
              <div><label className="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-2">Confirm Password</label><input type="password" value={confirm} onChange={(e) => setConfirm(e.target.value)} className="w-full px-4 py-3 rounded-xl bg-white/70 dark:bg-slate-900/70 border border-slate-200 dark:border-slate-700 focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 outline-none transition dark:text-white" /></div>
              <div><label className="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-2">Security Question</label><input type="text" value={question} onChange={(e) => setQuestion(e.target.value)} placeholder="e.g. Mother's maiden name" className="w-full px-4 py-3 rounded-xl bg-white/70 dark:bg-slate-900/70 border border-slate-200 dark:border-slate-700 focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 outline-none transition dark:text-white" /></div>
              <div><label className="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-2">Answer</label><input type="text" value={answer} onChange={(e) => setAnswer(e.target.value)} className="w-full px-4 py-3 rounded-xl bg-white/70 dark:bg-slate-900/70 border border-slate-200 dark:border-slate-700 focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 outline-none transition dark:text-white" /></div>
            </div>
            <button onClick={handleHide} className="w-full mt-6 py-3.5 bg-gradient-to-r from-purple-600 to-purple-500 hover:from-purple-500 hover:to-purple-400 text-white font-bold rounded-xl shadow-lg shadow-purple-500/30 transition-all flex items-center justify-center gap-2"><i className="fa-solid fa-lock"></i> Hide Album & Generate Codes</button>
          </div>
        </div>
      );
    };

    // âœ… FIXED: All hooks moved before any conditional return
    const BackupCodesModal = ({ isOpen, onClose, codes }) => {
      if (!isOpen || !codes) return null;
      return (
        <div className="fixed inset-0 z-[120] flex items-center justify-center p-4 bg-black/40 backdrop-blur-sm" onClick={onClose}>
          <div className="glass-modal rounded-3xl shadow-2xl max-w-lg w-full p-6 sm:p-8" onClick={e => e.stopPropagation()}>
            <h3 className="text-2xl font-bold text-slate-900 dark:text-white mb-4 flex items-center gap-3"><i className="fa-solid fa-shield text-green-500"></i><span>Your Backup Codes</span></h3>
            <p className="text-sm text-slate-600 dark:text-slate-400 mb-4">Each code can be used only once. Store them safely.</p>
            <div className="grid grid-cols-2 gap-2 mb-6">{codes.map((c, i) => <div key={i} className="backup-code text-center">{c.code}</div>)}</div>
            <button onClick={onClose} className="w-full py-3 bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 rounded-xl font-medium transition">I have saved the codes</button>
          </div>
        </div>
      );
    };

    // âœ… FIXED: All hooks moved before any conditional return
    const UnlockAlbumModal = ({ isOpen, onClose, albumName }) => {
      const { hiddenAlbums, useBackupCode, setUnlockedHidden, showAlbum, showToast, setActiveView } = useContext(AppContext);
      const [codeOrPw, setCodeOrPw] = useState('');
      const [showForgot, setShowForgot] = useState(false);
      const [answer, setAnswer] = useState('');

      if (!isOpen || !albumName) return null;
      const album = hiddenAlbums[albumName];
      if (!album) return null;

      const handleUnlock = async () => {
        if (!codeOrPw) return showToast('Enter password or code', 'error');
        const hashedInput = await hashString(codeOrPw);
        if (hashedInput === album.password) {
          setUnlockedHidden(prev => new Set(prev).add(albumName));
          onClose(); showAlbum(albumName); setActiveView('gallery');
        } else if (useBackupCode(albumName, codeOrPw)) {
          setUnlockedHidden(prev => new Set(prev).add(albumName));
          onClose(); showAlbum(albumName); setActiveView('gallery');
        } else { showToast('Invalid password or code', 'error'); }
      };

      const handleAnswer = async () => {
        const hashedAnswer = await hashString(answer.toLowerCase());
        if (hashedAnswer === album.answer) {
          setUnlockedHidden(prev => new Set(prev).add(albumName));
          onClose(); showAlbum(albumName); setActiveView('gallery');
        } else { showToast('Incorrect answer', 'error'); }
      };

      return (
        <div className="fixed inset-0 z-[130] flex items-center justify-center p-4 bg-black/40 backdrop-blur-sm" onClick={onClose}>
          <div className="glass-modal rounded-3xl shadow-2xl max-w-lg w-full p-6 sm:p-8" onClick={e => e.stopPropagation()}>
            <div className="flex justify-between items-center mb-4">
              <h3 className="text-xl font-bold text-slate-900 dark:text-white flex items-center gap-2"><i className="fa-solid fa-lock-open text-blue-500"></i> Unlock Album</h3>
              <button onClick={onClose} className="w-10 h-10 rounded-full bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 dark:hover:bg-slate-700"><i className="fa-solid fa-xmark"></i></button>
            </div>
            <div className="text-lg font-semibold text-purple-600 dark:text-purple-400 mb-2">{albumName}</div>
            <div className="space-y-4">
              <div>
                <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-2">Password or Backup Code</label>
                <input type="text" value={codeOrPw} onChange={(e) => setCodeOrPw(e.target.value)} placeholder="Enter password or one-time code" className="w-full px-4 py-3 rounded-xl bg-white/70 dark:bg-slate-900/70 border border-slate-200 dark:border-slate-700 focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 outline-none transition dark:text-white" />
              </div>
              {showForgot && (
                <div className="space-y-2">
                  <p className="text-sm text-slate-600 dark:text-slate-400">{album.question}</p>
                  <input type="text" value={answer} onChange={(e) => setAnswer(e.target.value)} placeholder="Answer" className="w-full px-4 py-2 rounded-xl border border-slate-200 dark:border-slate-700" />
                  <button onClick={handleAnswer} className="w-full py-2 bg-blue-600 text-white rounded-xl">Submit Answer</button>
                </div>
              )}
              <button onClick={() => setShowForgot(true)} className="text-xs text-blue-600 dark:text-blue-400 underline">Forgot password? Use security question</button>
            </div>
            <div className="flex gap-3 mt-6">
              <button onClick={handleUnlock} className="flex-1 py-3 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-xl transition">Unlock</button>
              <button onClick={onClose} className="flex-1 py-3 bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 rounded-xl transition">Cancel</button>
            </div>
          </div>
        </div>
      );
    };

    // âœ… FIXED: All hooks and refs moved before any conditional return
    const Lightbox = () => {
      const { 
        lightboxOpen, currentGallery, currentPhotoIndex, nextImage, prevImage, closeLightbox, 
        toggleSlideshow, slideshowInterval, toggleFavorite, favorites, deleteCurrentImage, 
        uploadedImages, activeAlbum, deletedImages, zoomScale, zoomTranslate, setZoomTranslate,
        handleZoomIn, handleZoomOut, handleZoomReset, setZoomScale
      } = useContext(AppContext);
      
      const [isDragging, setIsDragging] = useState(false);
      const [dragStart, setDragStart] = useState({ x: 0, y: 0 });
      const containerRef = useRef(null);

      useEffect(() => {
        return () => setIsDragging(false);
      }, []);

      if (!lightboxOpen) return null;
      
      const filename = currentGallery[currentPhotoIndex];
      let src;
      const inTrash = activeAlbum === 'Trash';
      if (inTrash) {
        const deleted = deletedImages.find(d => d.filename === filename);
        src = deleted ? deleted.dataURL : `${PATH_TO_IMAGES}${filename}`;
      } else {
        const uploaded = uploadedImages.find(img => img.filename === filename);
        src = uploaded ? uploaded.dataURL : `${PATH_TO_IMAGES}${filename}`;
      }
      const isVideo = filename?.toLowerCase().endsWith('.mp4');
      const isFav = favorites.has(filename);
      const showDelete = (uploadedImages.some(i => i.filename === filename) || inTrash) && activeAlbum !== 'Trash';

      const handleMouseDown = (e) => {
        if (zoomScale <= 1) return;
        e.preventDefault();
        setIsDragging(true);
        setDragStart({ x: e.clientX - zoomTranslate.x, y: e.clientY - zoomTranslate.y });
      };
      const handleMouseMove = (e) => {
        if (!isDragging) return;
        e.preventDefault();
        setZoomTranslate({
          x: e.clientX - dragStart.x,
          y: e.clientY - dragStart.y
        });
      };
      const handleMouseUp = () => setIsDragging(false);
      const handleDoubleClick = (e) => {
        e.preventDefault();
        if (zoomScale > 1) handleZoomReset();
        else handleZoomIn();
      };

      return (
        <div 
          className="fixed inset-0 z-50 bg-slate-950/95 backdrop-blur-md flex items-center justify-center transition-opacity duration-300 select-none" 
          onClick={closeLightbox}
          onMouseMove={handleMouseMove}
          onMouseUp={handleMouseUp}
          onMouseLeave={handleMouseUp}
        >
          <div className="absolute top-0 left-0 w-full h-1 bg-white/10 z-50">
            <div 
              key={currentPhotoIndex}
              className={`h-full bg-blue-500 ${slideshowInterval ? 'animate-progress' : 'w-0'}`} 
              style={{ width: slideshowInterval ? '100%' : '0' }}
            ></div>
          </div>

          <div className="absolute top-0 left-0 w-full p-4 flex justify-between items-center z-50 pointer-events-none">
            <span className="text-white/80 font-mono text-xs pointer-events-auto bg-white/10 border border-white/10 px-3 py-1.5 rounded-full backdrop-blur-md">
              {currentPhotoIndex+1} / {currentGallery.length}
            </span>
            <div className="flex items-center gap-2 pointer-events-auto">
              <button onClick={toggleSlideshow} className="w-10 h-10 rounded-full bg-white/10 hover:bg-white/20 border border-white/10 text-white transition">
                <i className={`fa-solid ${slideshowInterval ? 'fa-pause' : 'fa-play'} text-sm`}></i>
              </button>
              <button onClick={() => toggleFavorite(filename)} className="w-10 h-10 rounded-full bg-white/10 hover:bg-white/20 border border-white/10 text-white transition">
                <i className={`fa-${isFav ? 'solid text-red-500' : 'regular'} fa-heart text-lg`}></i>
              </button>
              {showDelete && (
                <button onClick={deleteCurrentImage} className="w-10 h-10 rounded-full bg-white/10 hover:bg-red-500/80 border border-white/10 text-white transition">
                  <i className="fa-solid fa-trash text-sm"></i>
                </button>
              )}
              <button onClick={() => { const a = document.createElement('a'); a.href = src; a.download = filename; a.click(); }} className="w-10 h-10 rounded-full bg-white/10 hover:bg-white/20 border border-white/10 text-white transition">
                <i className="fa-solid fa-download text-sm"></i>
              </button>
              <button onClick={closeLightbox} className="w-10 h-10 rounded-full bg-white/10 hover:bg-white/20 border border-white/10 text-white transition">
                <i className="fa-solid fa-xmark"></i>
              </button>
            </div>
          </div>

          <div className="absolute left-1/2 -translate-x-1/2 bottom-6 flex items-center gap-2 z-50 bg-black/40 backdrop-blur-md rounded-full px-3 py-2 border border-white/10">
            <button onClick={handleZoomOut} className="w-8 h-8 rounded-full bg-white/10 hover:bg-white/20 text-white text-sm">âˆ’</button>
            <span className="text-white text-xs px-1">{Math.round(zoomScale * 100)}%</span>
            <button onClick={handleZoomIn} className="w-8 h-8 rounded-full bg-white/10 hover:bg-white/20 text-white text-sm">+</button>
            <button onClick={handleZoomReset} className="w-8 h-8 rounded-full bg-white/10 hover:bg-white/20 text-white text-xs ml-1">
              <i className="fa-solid fa-arrows-to-circle"></i>
            </button>
          </div>

          <button onClick={(e) => { e.stopPropagation(); prevImage(); }} className="absolute left-3 sm:left-6 top-1/2 -translate-y-1/2 w-12 h-12 sm:w-14 sm:h-14 rounded-full bg-white/10 hover:bg-white/20 border border-white/10 text-white flex items-center justify-center z-50 backdrop-blur-md transition group active:scale-95">
            <i className="fa-solid fa-chevron-left text-xl group-hover:-translate-x-0.5 transition-transform"></i>
          </button>
          <button onClick={(e) => { e.stopPropagation(); nextImage(); }} className="absolute right-3 sm:right-6 top-1/2 -translate-y-1/2 w-12 h-12 sm:w-14 sm:h-14 rounded-full bg-white/10 hover:bg-white/20 border border-white/10 text-white flex items-center justify-center z-50 backdrop-blur-md transition group active:scale-95">
            <i className="fa-solid fa-chevron-right text-xl group-hover:translate-x-0.5 transition-transform"></i>
          </button>

          <div 
            className="relative w-full h-full flex items-center justify-center p-4 sm:px-20 overflow-hidden"
            onClick={e => e.stopPropagation()}
            ref={containerRef}
          >
            {isVideo ? (
              <video src={src} controls className="max-h-full max-w-full rounded-lg shadow-2xl shadow-black/50" autoPlay />
            ) : (
              <div 
                className="zoom-container"
                style={{ transform: `scale(${zoomScale}) translate(${zoomTranslate.x}px, ${zoomTranslate.y}px)` }}
                onMouseDown={handleMouseDown}
                onDoubleClick={handleDoubleClick}
              >
                <img 
                  src={src} 
                  alt="" 
                  className="max-h-[90vh] max-w-[90vw] object-contain rounded-lg shadow-2xl shadow-black/50 select-none"
                  draggable="false"
                />
              </div>
            )}
            <div className="absolute bottom-8 text-center w-full px-12 pointer-events-none">
              <span className="inline-block bg-black/40 border border-white/10 text-white/90 px-4 py-2 rounded-full text-xs backdrop-blur-md font-mono truncate max-w-[90%]">{filename}</span>
            </div>
          </div>
        </div>
      );
    };

    const Toast = ({ show, msg, type }) => { if (!show) return null; const bg = type === 'success' ? 'bg-emerald-600/95' : 'bg-red-600/95'; return (<div className={`fixed ${type === 'success' ? 'bottom-6' : 'top-6'} left-1/2 -translate-x-1/2 ${bg} text-white px-6 py-3 rounded-full shadow-2xl backdrop-blur-md flex items-center gap-3 transition-all duration-500 z-[80]`}><i className={`fa-solid ${type === 'success' ? 'fa-check-circle' : 'fa-circle-exclamation'}`}></i><span className="font-bold text-xs">{msg}</span></div>); };

    const Footer = () => {
      const { getAllVisiblePhotos, favorites, deletedImages } = useContext(AppContext);
      const total = getAllVisiblePhotos().length;
      return (
        <footer className="w-full py-8 mt-auto border-t border-slate-200 dark:border-slate-800 text-center">
          <div className="flex flex-col items-center gap-1">
            <span className="text-sm font-semibold text-slate-900 dark:text-slate-100">{total} Photos Â· {favorites.size} Favorites Â· Trash {deletedImages.length}</span>
            <span className="text-[10px] font-medium text-slate-400 uppercase tracking-wider">Smart Gallery Â· React PWA</span>
          </div>
        </footer>
      );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>